{
  "nodes": [
    {
      "parameters": {
        "path": "social_approval",
        "responseMode": "responseNode",
        "options": {}
      },
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        -128,
        -2208
      ],
      "id": "4adf9f17-3fa2-456f-823f-fbabded18c4f",
      "webhookId": "<PUT HERE YOUR GOOGLE WEBHOOK ID>"
    },
    {
      "parameters": {
        "jsCode": "const webhook = $('Webhook').first();\nconst query = webhook.json.query || {};\n\nconst actionRaw = String(query.action || '').toLowerCase();\nconst targetId  = query.id;\nconst sessionId = query.session_id;\n\n// Se manca qualcosa di fondamentale, non facciamo nulla\nif (!sessionId || !actionRaw) {\n  return [];\n}\n\nconst items = $input.all();\n\nreturn items\n  .filter(item => {\n    const json = item.json;\n\n    // 1) stessa sessione\n    if (json.session_id !== sessionId) return false;\n\n    // 2) idempotenza: processiamo SOLO ciò che è ancora in attesa\n    const approval = (json.approval_flag || '').toUpperCase();\n    const status   = (json.status || '').toUpperCase();\n\n    // se già approvato/rifiutato → salta\n    if (approval && approval !== 'PENDING') return false;\n\n    // se lo status è già finale (SCHEDULED, CANCELLED, PUBLISHED, FAILED, ecc.) → salta\n    if (status !== 'READY_FOR_APPROVAL') return false;\n\n    // 3) filtro per azione\n    if (actionRaw.includes('all')) {\n      // approve_all / reject_all → tutti i post PENDING + READY_FOR_APPROVAL della sessione\n      return true;\n    }\n\n    // approve_one / reject_one → solo il post con quell'id\n    return String(json.id) === String(targetId);\n  })\n  .map(item => {\n    const json = item.json;\n\n    // Salvo l'id della riga del foglio, per usarlo dopo come chiave di update\n    json.sheet_id = json.id;\n\n    const isApprove = actionRaw.includes('approve');\n\n    if (isApprove) {\n      json.approval_flag = 'APPROVED';\n\n      const publishMode = json.publish_mode || 'SCHEDULED';\n\n      if (publishMode === 'IMMEDIATE_AFTER_APPROVAL') {\n        // Niente evento in calendario: pubblicazione immediata dopo approvazione\n        json.scheduled_time = new Date().toISOString();\n        json.status = 'SCHEDULED';\n        json.do_calendar = false;\n      } else {\n        // Post programmato in futuro\n\n        // Se esiste già un evento di calendario, NON crearne un altro\n        if (json.calendar_event_id) {\n          json.status = 'SCHEDULED';\n          json.do_calendar = false;\n        } else {\n          json.status = 'SCHEDULED';\n          json.do_calendar = true;\n        }\n      }\n    } else {\n      // REJECT\n      json.approval_flag = 'REJECTED';\n      json.status = 'CANCELLED';\n      json.do_calendar = false;\n    }\n\n    return item;\n  });\n"
      },
      "name": "Apply Approval Logic",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        272,
        -2208
      ],
      "id": "72572c7c-3779-405e-813d-1359ba30f62f"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.do_calendar }}",
              "value2": true
            }
          ]
        }
      },
      "name": "Needs Calendar?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        464,
        -2208
      ],
      "id": "a98a09d6-ca74-46f3-a9d6-1b024fda447f"
    },
    {
      "parameters": {
        "calendar": {
          "__rl": true,
          "value": "<PUT HERE YOUR GOOGLE CALENDAR ID>",
          "mode": "list",
          "cachedResultName": "<PUT HERE YOUR GOOGLE CALENDAR NAME>"
        },
        "start": "={{ $json.scheduled_time }}",
        "end": "={{ $json.scheduled_time }}",
        "additionalFields": {
          "description": "={{ $json[\"post_text\"] }}{{ $json[\"hashtags\"] ? \"\\n\\n#\" + $json[\"hashtags\"] : \"\" }}",
          "summary": "={{ $json[\"campaign_title\"] }} – {{ $json[\"platform\"] }}"
        }
      },
      "name": "Create Calendar Event",
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1,
      "position": [
        640,
        -2352
      ],
      "id": "d5cf754a-1895-431e-a4e4-0f9e90c91d1c",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "<PUT HERE YOUR_CREDENTIALS_ID>",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition",
        "options": {}
      },
      "name": "Merge Calendar Data",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [
        912,
        -2320
      ],
      "id": "f5e2e89a-0c13-408d-b744-0b1adc0b0620"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "Action processed successfully. You can close this window.",
        "options": {}
      },
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1552,
        -2160
      ],
      "id": "0464bffe-a23e-4b19-9d10-3e268a493e3e"
    },
    {
      "parameters": {
        "jsCode": "return $input.all().filter(item => item.json.calendar_event_id);"
      },
      "name": "Filter with Event ID",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        272,
        -1856
      ],
      "id": "a4c74511-0aac-4893-bec4-42401a9d5c62"
    },
    {
      "parameters": {
        "operation": "get",
        "calendar": {
          "__rl": true,
          "value": "<PUT HERE YOUR GOOGLE CALENDAR ID>",
          "mode": "list",
          "cachedResultName": "<PUT HERE YOUR GOOGLE CALENDAR NAME>"
        },
        "eventId": "={{ $json.calendar_event_id }}",
        "options": {}
      },
      "name": "Get Calendar Event",
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1,
      "position": [
        480,
        -1856
      ],
      "id": "67e2c9bc-4637-45a8-b949-09da33685e2f",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "<PUT HERE YOUR_CREDENTIALS_ID>",
          "name": "Google Calendar account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition",
        "options": {}
      },
      "name": "Merge Event Data",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [
        1056,
        -1856
      ],
      "id": "65a748ab-8886-4724-bc4b-e6ec5cbad280"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst results = [];\n\nfor (const item of items) {\n  const json = item.json;\n\n  const sheetId = json.id;\n  const sheetTime = json.scheduled_time;\n\n  // servono id, scheduled_time e start dall'evento di calendario\n  if (!sheetId || !sheetTime || !json.start) {\n    continue;\n  }\n\n  const calTime = json.start.dateTime || json.start.date;\n  if (!calTime) continue;\n\n  const t1 = new Date(calTime).getTime();\n  const t2 = new Date(sheetTime).getTime();\n\n  if (isNaN(t1) || isNaN(t2)) continue;\n\n  // tolleranza 1 minuto\n  if (Math.abs(t1 - t2) > 60000) {\n    results.push({\n      json: {\n        id: sheetId,\n        scheduled_time: calTime\n      }\n    });\n  }\n}\n\nreturn results;\n"
      },
      "name": "Check Changes",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        1248,
        -1856
      ],
      "id": "425d057d-9d05-49d7-9768-1301b5f9c03f"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 2
            }
          ]
        }
      },
      "name": "Cron2",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [
        -128,
        -1856
      ],
      "id": "a41c69d1-92ef-4e51-9e27-af7f895b8e9e"
    },
    {
      "parameters": {
        "jsCode": "return $input.all().filter(item => {\n  const status = String(item.json.status || '').toUpperCase();\n  return ['FAILED', 'ERROR'].includes(status);\n});\n"
      },
      "name": "Filter Errors",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        1280,
        400
      ],
      "id": "1925a3b3-1b8d-47a7-a642-8b17d6ae8b59"
    },
    {
      "parameters": {
        "authentication": "gmailOAuth2",
        "sendTo": "<PUT HERE YOUR MAIL ADDRESS>",
        "subject": "Social Media Manager: Errors Detected",
        "message": "={{ JSON.stringify($input.all().map(item => item.json), null, 2) }}",
        "options": {}
      },
      "name": "Send Alert Email",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2,
      "position": [
        1488,
        400
      ],
      "id": "8de99a10-9b07-4d47-94c8-0104e9e3e58c",
      "webhookId": "<PUT HERE YOUR WEBHOOK_ID>"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours"
            }
          ]
        }
      },
      "name": "Cron4",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [
        864,
        400
      ],
      "id": "022f7e93-237a-4f1c-a276-f72409d1a82f"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst now = new Date().getTime();\n\nreturn items.filter(item => {\n  const { scheduled_time, status, approval_flag } = item.json;\n  \n  // Considero solo le righe davvero da pubblicare\n  if (status !== 'SCHEDULED') return false;\n  if (approval_flag !== 'APPROVED') return false;\n  if (!scheduled_time) return false;\n  \n  // Se scheduled_time non ha timezone, assumo Europe/Rome\n  // Fix malformed time format - MANCANTE!\n  let timeStr = scheduled_time.replace(/T(\\d):/, 'T0$1:')\n                               .replace(/:(\\d):/, ':0$1:')\n                               .replace(/:(\\d)$/, ':0$1');\n  if (!timeStr.includes('+') && !timeStr.includes('Z') && !timeStr.includes('-', 10)) {\n    timeStr = timeStr + '+01:00';  // Europe/Rome in inverno (CET)\n  }\n  \n  const scheduled = new Date(timeStr).getTime();\n  return scheduled <= now;\n});"
      },
      "name": "Filter by Time",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        576,
        -896
      ],
      "id": "ff801660-0c83-411f-9687-07b3374c1d16"
    },
    {
      "parameters": {
        "dataType": "string",
        "value1": "={{ $json.platform }}",
        "rules": {
          "rules": [
            {
              "value2": "facebook"
            },
            {
              "value2": "instagram",
              "output": 1
            },
            {
              "value2": "tiktok",
              "output": 2
            }
          ]
        },
        "fallbackOutput": 3
      },
      "name": "Switch Platform 1",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [
        800,
        -928
      ],
      "id": "2c57c135-5249-4db9-8d81-6671c5bfef80"
    },
    {
      "parameters": {
        "dataType": "string",
        "value1": "={{ $json.platform }}",
        "rules": {
          "rules": [
            {
              "value2": "youtube"
            },
            {
              "value2": "whatsapp",
              "output": 1
            },
            {
              "value2": "x",
              "output": 2
            }
          ]
        }
      },
      "name": "Switch Platform 2",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [
        1088,
        -368
      ],
      "id": "f5b7f64e-72ff-4c77-bab1-889afd07b5cc"
    },
    {
      "parameters": {
        "resource": "video",
        "filters": {},
        "options": {}
      },
      "name": "YouTube Publish",
      "type": "n8n-nodes-base.youTube",
      "typeVersion": 1,
      "position": [
        1392,
        -336
      ],
      "id": "57021550-fc85-4783-b318-bb081f2cd4fe",
      "disabled": true,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "phoneNumberId": "YOUR_PHONE_ID",
        "recipientPhoneNumber": "={{ $json.target_phone_number }}"
      },
      "name": "WhatsApp Publish",
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        1392,
        -176
      ],
      "id": "7fdee28e-0cce-4e83-a683-11077e78a44c",
      "webhookId": "<PUT HERE YOUR GOOGLE WEBHOOK ID>",
      "disabled": true,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "text": "={{ $json.post_text }} #{{ $json.hashtags }}",
        "additionalFields": {}
      },
      "name": "X Publish",
      "type": "n8n-nodes-base.twitter",
      "typeVersion": 1,
      "position": [
        1392,
        -32
      ],
      "id": "60c58712-3b36-4ab5-b340-f286e5a79a95",
      "disabled": true,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition",
        "options": {}
      },
      "name": "Merge IG",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [
        1984,
        -1088
      ],
      "id": "59ca64fb-c789-4755-ae83-0525b4404b52"
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition",
        "options": {}
      },
      "name": "Merge TikTok",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [
        1664,
        -560
      ],
      "id": "0cbbb7fc-d2f4-4b85-ab6c-a9967b82a611",
      "disabled": true
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition",
        "options": {}
      },
      "name": "Merge YT",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [
        1664,
        -336
      ],
      "id": "2b9f246c-7c27-4cab-90d0-ffb80988e93e",
      "disabled": true
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition",
        "options": {}
      },
      "name": "Merge WA",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [
        1664,
        -176
      ],
      "id": "7796d619-86a1-4cc0-b323-944dbea9aa1f",
      "disabled": true
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition",
        "options": {}
      },
      "name": "Merge X",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [
        1664,
        -32
      ],
      "id": "f4b5aac0-bfcd-4b20-b10a-fc77941a2817",
      "disabled": true
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 3
            }
          ]
        }
      },
      "name": "Cron3",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [
        -48,
        -896
      ],
      "id": "541ff3f6-7718-4274-9a6b-c9fe3132b9c4"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://open.tiktokapis.com/v2/post/publish/video/init/",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "name": "TikTok Publish",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        1408,
        -560
      ],
      "id": "af5c0dd1-014a-4c17-a495-5f637ae71a68",
      "disabled": true,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "<PUT HERE YOUR GOOGLE SHEET ID>",
          "mode": "list",
          "cachedResultName": "Social_Media_Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Variabili_di_input-output",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit#gid=0"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        80,
        -1856
      ],
      "id": "4fa6b494-fb96-4d91-8074-033f2585a6c3",
      "name": "Read Scheduled Items",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "<PUT HERE YOUR_CREDENTIALS_ID>",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "<PUT HERE YOUR GOOGLE SHEET ID>",
          "mode": "list",
          "cachedResultName": "Social_Media_Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Variabili_di_input-output",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit#gid=0"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {},
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "import_source_row",
              "displayName": "import_source_row",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_email",
              "displayName": "user_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "campaign_title",
              "displayName": "campaign_title",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "platform",
              "displayName": "platform",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "post_text",
              "displayName": "post_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "hashtags",
              "displayName": "hashtags",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "media_source",
              "displayName": "media_source",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "media_type",
              "displayName": "media_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "media_variant",
              "displayName": "media_variant",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "scheduled_time",
              "displayName": "scheduled_time",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "publish_mode",
              "displayName": "publish_mode",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "target_phone_number",
              "displayName": "target_phone_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "approval_flag",
              "displayName": "approval_flag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "generate_common_image",
              "displayName": "generate_common_image",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_image_prompt",
              "displayName": "common_image_prompt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_image_status",
              "displayName": "common_image_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_image_url",
              "displayName": "common_image_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "generate_common_video",
              "displayName": "generate_common_video",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_video_prompt",
              "displayName": "common_video_prompt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_video_status",
              "displayName": "common_video_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_video_url",
              "displayName": "common_video_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "public_url",
              "displayName": "public_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "local_path",
              "displayName": "local_path",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "saved_locally",
              "displayName": "saved_locally",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "final_filename",
              "displayName": "final_filename",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "remote_filename",
              "displayName": "remote_filename",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "remotePath",
              "displayName": "remotePath",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "local_full_path",
              "displayName": "local_full_path",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "remote_full_path",
              "displayName": "remote_full_path",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "publish_attempts",
              "displayName": "publish_attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "error_message",
              "displayName": "error_message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "calendar_event_id",
              "displayName": "calendar_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        848,
        -2128
      ],
      "id": "7c4451a3-9c8c-4533-9ac7-df4097a11bde",
      "name": "Update Sheet (No Calendar)1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "<PUT HERE YOUR_CREDENTIALS_ID>",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "<PUT HERE YOUR GOOGLE SHEET ID>",
          "mode": "list",
          "cachedResultName": "Social_Media_Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Variabili_di_input-output",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit#gid=0"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {},
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "import_source_row",
              "displayName": "import_source_row",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_email",
              "displayName": "user_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "campaign_title",
              "displayName": "campaign_title",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "platform",
              "displayName": "platform",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "post_text",
              "displayName": "post_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "hashtags",
              "displayName": "hashtags",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "media_source",
              "displayName": "media_source",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "media_type",
              "displayName": "media_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "media_variant",
              "displayName": "media_variant",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "scheduled_time",
              "displayName": "scheduled_time",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "publish_mode",
              "displayName": "publish_mode",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "target_phone_number",
              "displayName": "target_phone_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "approval_flag",
              "displayName": "approval_flag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "generate_common_image",
              "displayName": "generate_common_image",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_image_prompt",
              "displayName": "common_image_prompt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_image_status",
              "displayName": "common_image_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_image_url",
              "displayName": "common_image_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "generate_common_video",
              "displayName": "generate_common_video",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_video_prompt",
              "displayName": "common_video_prompt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_video_status",
              "displayName": "common_video_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_video_url",
              "displayName": "common_video_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "public_url",
              "displayName": "public_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "local_path",
              "displayName": "local_path",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "saved_locally",
              "displayName": "saved_locally",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "final_filename",
              "displayName": "final_filename",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "remote_filename",
              "displayName": "remote_filename",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "remotePath",
              "displayName": "remotePath",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "local_full_path",
              "displayName": "local_full_path",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "remote_full_path",
              "displayName": "remote_full_path",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "publish_attempts",
              "displayName": "publish_attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "error_message",
              "displayName": "error_message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "calendar_event_id",
              "displayName": "calendar_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1328,
        -2272
      ],
      "id": "691ae7ca-51db-4ce0-9190-f77be61a6caf",
      "name": "Update Sheet (Calendar)1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "<PUT HERE YOUR_CREDENTIALS_ID>",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "<PUT HERE YOUR GOOGLE SHEET ID>",
          "mode": "list",
          "cachedResultName": "Social_Media_Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Variabili_di_input-output",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit#gid=0"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {},
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "import_source_row",
              "displayName": "import_source_row",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_email",
              "displayName": "user_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "campaign_title",
              "displayName": "campaign_title",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "platform",
              "displayName": "platform",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "post_text",
              "displayName": "post_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "hashtags",
              "displayName": "hashtags",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "media_source",
              "displayName": "media_source",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "media_type",
              "displayName": "media_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "media_variant",
              "displayName": "media_variant",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "scheduled_time",
              "displayName": "scheduled_time",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "publish_mode",
              "displayName": "publish_mode",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "target_phone_number",
              "displayName": "target_phone_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "approval_flag",
              "displayName": "approval_flag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "generate_common_image",
              "displayName": "generate_common_image",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_image_prompt",
              "displayName": "common_image_prompt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_image_status",
              "displayName": "common_image_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_image_url",
              "displayName": "common_image_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "generate_common_video",
              "displayName": "generate_common_video",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_video_prompt",
              "displayName": "common_video_prompt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_video_status",
              "displayName": "common_video_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_video_url",
              "displayName": "common_video_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "public_url",
              "displayName": "public_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "local_path",
              "displayName": "local_path",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "saved_locally",
              "displayName": "saved_locally",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "final_filename",
              "displayName": "final_filename",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "remote_filename",
              "displayName": "remote_filename",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "remotePath",
              "displayName": "remotePath",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "local_full_path",
              "displayName": "local_full_path",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "remote_full_path",
              "displayName": "remote_full_path",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "publish_attempts",
              "displayName": "publish_attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "error_message",
              "displayName": "error_message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "calendar_event_id",
              "displayName": "calendar_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1408,
        -1856
      ],
      "id": "c6a63105-5cc2-4886-bb44-7ca846f28baa",
      "name": "Update Sheet1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "<PUT HERE YOUR_CREDENTIALS_ID>",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "<PUT HERE YOUR GOOGLE SHEET ID>",
          "mode": "list",
          "cachedResultName": "Social_Media_Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Variabili_di_input-output",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit#gid=0"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        64,
        -2208
      ],
      "id": "c13502f1-3ece-41df-b1cb-6ab2c6fedf10",
      "name": "Read Session Items",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "<PUT HERE YOUR_CREDENTIALS_ID>",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "<PUT HERE YOUR GOOGLE SHEET ID>",
          "mode": "list",
          "cachedResultName": "Social_Media_Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Variabili_di_input-output",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit#gid=0"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        176,
        -896
      ],
      "id": "a8e0f9c8-acab-4416-96a0-3a71b94d39aa",
      "name": "Read Scheduled",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "<PUT HERE YOUR_CREDENTIALS_ID>",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "<PUT HERE YOUR GOOGLE SHEET ID>",
          "mode": "list",
          "cachedResultName": "Social_Media_Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Variabili_di_input-output",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit#gid=0"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {},
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "import_source_row",
              "displayName": "import_source_row",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_email",
              "displayName": "user_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "campaign_title",
              "displayName": "campaign_title",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "platform",
              "displayName": "platform",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "post_text",
              "displayName": "post_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "hashtags",
              "displayName": "hashtags",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "media_source",
              "displayName": "media_source",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "media_type",
              "displayName": "media_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "media_variant",
              "displayName": "media_variant",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "scheduled_time",
              "displayName": "scheduled_time",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "publish_mode",
              "displayName": "publish_mode",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "target_phone_number",
              "displayName": "target_phone_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "approval_flag",
              "displayName": "approval_flag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "generate_common_image",
              "displayName": "generate_common_image",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_image_prompt",
              "displayName": "common_image_prompt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_image_status",
              "displayName": "common_image_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_image_url",
              "displayName": "common_image_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "generate_common_video",
              "displayName": "generate_common_video",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_video_prompt",
              "displayName": "common_video_prompt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_video_status",
              "displayName": "common_video_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_video_url",
              "displayName": "common_video_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "public_url",
              "displayName": "public_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "local_path",
              "displayName": "local_path",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "saved_locally",
              "displayName": "saved_locally",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "final_filename",
              "displayName": "final_filename",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "remote_filename",
              "displayName": "remote_filename",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "remotePath",
              "displayName": "remotePath",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "local_full_path",
              "displayName": "local_full_path",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "remote_full_path",
              "displayName": "remote_full_path",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "publish_attempts",
              "displayName": "publish_attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "error_message",
              "displayName": "error_message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "calendar_event_id",
              "displayName": "calendar_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        3568,
        -928
      ],
      "id": "a65cdc4f-cb1f-454f-8d9f-6cef53a48de6",
      "name": "Update Status",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "<PUT HERE YOUR_CREDENTIALS_ID>",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "<PUT HERE YOUR GOOGLE SHEET ID>",
          "mode": "list",
          "cachedResultName": "Social_Media_Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Variabili_di_input-output",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit#gid=0"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1088,
        400
      ],
      "id": "ae291adc-ff2f-4e6e-a867-1eee62c6290f",
      "name": "Read All Items",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "<PUT HERE YOUR_CREDENTIALS_ID>",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nreturn items.map(item => {\n  const json = item.json;\n\n  // 🔹 ripristino l'id della riga dello Sheet, se presente\n  if (json.sheet_id) {\n    json.id = json.sheet_id;\n  }\n\n  const attempts = Number(json.publish_attempts || 0);\n\n  if (json.error) {\n    json.status = 'FAILED';\n    json.error_message = json.error.message || 'Publish error';\n    json.publish_attempts = String(attempts + 1);\n  } else {\n    json.status = 'PUBLISHED';\n    json.error_message = '';\n    json.publish_attempts = String(attempts + 1);\n  }\n\n  if (!['facebook','instagram'].includes(json.platform)) {\n    json.status = 'FAILED';\n    json.error_message = 'Platform not yet supported';\n  }\n\n  return item;\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3264,
        -912
      ],
      "id": "9383cae4-8b39-4a74-b3ef-c19f6b647495",
      "name": "Set Publish Status",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\n// Recupera gli eventi calendario dal nodo originale (prima del merge)\nconst calendarItems = $('Create Calendar Event').all();\n\nreturn items.map((item, index) => {\n  const json = item.json;\n\n  // Prendi l'ID evento direttamente dal nodo Calendar, NON dal merge\n  const calendarEvent = calendarItems[index]?.json;\n  if (calendarEvent?.id) {\n    json.calendar_event_id = calendarEvent.id;\n  }\n\n  // ripristino l'id della riga del foglio\n  if (json.sheet_id) {\n    json.id = json.sheet_id;\n    delete json.sheet_id;\n  }\n\n  // allineo scheduled_time con quello dell'evento\n  if (json.start) {\n    const start = json.start.dateTime || json.start.date;\n    if (start) {\n      json.scheduled_time = start;\n    }\n  }\n\n  return item;\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1104,
        -2320
      ],
      "id": "1b481247-5f99-448e-b8b0-47ef1f347e1d",
      "name": "Prepare Calendar Update"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "<PUT HERE YOUR GOOGLE SHEET ID>",
          "mode": "list",
          "cachedResultName": "Social_Media_Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Variabili_di_input-output",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit#gid=0"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {},
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "import_source_row",
              "displayName": "import_source_row",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_email",
              "displayName": "user_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "campaign_title",
              "displayName": "campaign_title",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "platform",
              "displayName": "platform",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "post_text",
              "displayName": "post_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "hashtags",
              "displayName": "hashtags",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "media_source",
              "displayName": "media_source",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "media_type",
              "displayName": "media_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "media_variant",
              "displayName": "media_variant",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "scheduled_time",
              "displayName": "scheduled_time",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "publish_mode",
              "displayName": "publish_mode",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "target_phone_number",
              "displayName": "target_phone_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "approval_flag",
              "displayName": "approval_flag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "generate_common_image",
              "displayName": "generate_common_image",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_image_prompt",
              "displayName": "common_image_prompt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_image_status",
              "displayName": "common_image_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_image_url",
              "displayName": "common_image_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "generate_common_video",
              "displayName": "generate_common_video",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_video_prompt",
              "displayName": "common_video_prompt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_video_status",
              "displayName": "common_video_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_video_url",
              "displayName": "common_video_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "public_url",
              "displayName": "public_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "local_path",
              "displayName": "local_path",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "saved_locally",
              "displayName": "saved_locally",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "final_filename",
              "displayName": "final_filename",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "remote_filename",
              "displayName": "remote_filename",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "remotePath",
              "displayName": "remotePath",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "local_full_path",
              "displayName": "local_full_path",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "remote_full_path",
              "displayName": "remote_full_path",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "publish_attempts",
              "displayName": "publish_attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "error_message",
              "displayName": "error_message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "calendar_event_id",
              "displayName": "calendar_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        400,
        208
      ],
      "id": "cada3629-2fa6-4698-b84a-1fb12e20ab48",
      "name": "Update Sheet Error1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "<PUT HERE YOUR_CREDENTIALS_ID>",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst results = [];\n\nfor (const item of items) {\n  const root = item.json || {};\n\n  // n8n in caso di errore di solito mette:\n  // { \"error\": {...}, \"json\": { ...original... } }\n  const error = root.error;\n  const original = root.json || root;\n\n  // Se per qualche motivo non c'è errore, passo solo l'originale\n  if (!error) {\n    results.push({ json: original });\n    continue;\n  }\n\n  const attempts = Number(original.publish_attempts || 0);\n  const message = error.message || 'Media publishing error';\n\n  results.push({\n    json: {\n      ...original,\n      // 🔹 id corretto per aggiornare lo Sheet\n      id: original.sheet_id || original.id,\n      status: 'ERROR',                    // o 'FAILED' se vuoi distinguere da ERROR “di sistema”\n      // 🔹 NON tocchiamo approval_flag (resta APPROVED/whatever)\n      error_message: message,\n      publish_attempts: String(attempts + 1),\n    }\n  });\n}\n\nreturn results;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -80,
        208
      ],
      "id": "ff083e26-b817-44c8-870a-9033b25b8820",
      "name": "Set PUBLISHING ERRORS"
    },
    {
      "parameters": {
        "httpRequestMethod": "POST",
        "graphApiVersion": "v23.0",
        "node": "<PUT HERE YOUR FACEBOOK PAGE ID>",
        "edge": "photos",
        "options": {
          "queryParameters": {
            "parameter": [
              {
                "name": "url",
                "value": "={{ $json.public_url }}"
              },
              {
                "name": "caption",
                "value": "={{ $json.post_text + '\\\\n\\\\n' + $json.hashtags }}"
              }
            ]
          }
        }
      },
      "name": "Facebook Publish Image",
      "type": "n8n-nodes-base.facebookGraphApi",
      "typeVersion": 1,
      "position": [
        1344,
        -1552
      ],
      "id": "d47bfd69-22c2-491c-8638-dba308ca153f",
      "credentials": {
        "facebookGraphApi": {
          "id": "<<PUT HERE YOUR REDENTIAL_ID>",
          "name": "Facebook Graph account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "httpRequestMethod": "POST",
        "graphApiVersion": "v23.0",
        "node": "<PUT HERE YOUR FACEBOOK PAGE ID>",
        "edge": "video",
        "options": {
          "queryParameters": {
            "parameter": [
              {
                "name": "file_url",
                "value": "={{ $json.public_url }}"
              },
              {
                "name": "caption",
                "value": "={{ $json.post_text + '\\\\n\\\\n' + $json.hashtags }}"
              }
            ]
          }
        }
      },
      "name": "Facebook Publish VIdeo",
      "type": "n8n-nodes-base.facebookGraphApi",
      "typeVersion": 1,
      "position": [
        1344,
        -1264
      ],
      "id": "0a92fcda-a94c-4000-a062-acbb69a0376c",
      "credentials": {
        "facebookGraphApi": {
          "id": "<<PUT HERE YOUR REDENTIAL_ID>",
          "name": "Facebook Graph account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "dataType": "string",
        "value1": "={{ $json.media_type }}",
        "rules": {
          "rules": [
            {
              "value2": "image"
            },
            {
              "value2": "video",
              "output": 1
            },
            {
              "value2": "none",
              "output": 2
            }
          ]
        }
      },
      "name": "Switch Platform ",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [
        1056,
        -1376
      ],
      "id": "d331cca9-d99c-4694-86ed-c182fd59676b"
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition",
        "options": {}
      },
      "name": "Merge FB Image",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [
        1600,
        -1552
      ],
      "id": "e8a26731-bfd9-4024-ab65-c4da00dada4f"
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition",
        "options": {}
      },
      "name": "Merge FB Video",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [
        1600,
        -1264
      ],
      "id": "57059b22-4d7e-4719-b745-a82055e0ba85"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "<PUT HERE YOUR GOOGLE SHEET ID>",
          "mode": "list",
          "cachedResultName": "Social_Media_Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Variabili_di_input-output",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit#gid=0"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {},
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "import_source_row",
              "displayName": "import_source_row",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_email",
              "displayName": "user_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "campaign_title",
              "displayName": "campaign_title",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "platform",
              "displayName": "platform",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "post_text",
              "displayName": "post_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "hashtags",
              "displayName": "hashtags",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "media_source",
              "displayName": "media_source",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "media_type",
              "displayName": "media_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "media_variant",
              "displayName": "media_variant",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "scheduled_time",
              "displayName": "scheduled_time",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "publish_mode",
              "displayName": "publish_mode",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "target_phone_number",
              "displayName": "target_phone_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "approval_flag",
              "displayName": "approval_flag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "generate_common_image",
              "displayName": "generate_common_image",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_image_prompt",
              "displayName": "common_image_prompt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_image_status",
              "displayName": "common_image_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_image_url",
              "displayName": "common_image_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "generate_common_video",
              "displayName": "generate_common_video",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_video_prompt",
              "displayName": "common_video_prompt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_video_status",
              "displayName": "common_video_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_video_url",
              "displayName": "common_video_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "public_url",
              "displayName": "public_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "local_path",
              "displayName": "local_path",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "saved_locally",
              "displayName": "saved_locally",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "final_filename",
              "displayName": "final_filename",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "remote_filename",
              "displayName": "remote_filename",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "remotePath",
              "displayName": "remotePath",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "local_full_path",
              "displayName": "local_full_path",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "remote_full_path",
              "displayName": "remote_full_path",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "publish_attempts",
              "displayName": "publish_attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "error_message",
              "displayName": "error_message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "calendar_event_id",
              "displayName": "calendar_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        832,
        -1776
      ],
      "id": "9f734bda-2359-4e3c-8342-22e6bb515cde",
      "name": "Update Sheet Error2",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "<PUT HERE YOUR_CREDENTIALS_ID>",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst results = [];\n\nfor (const item of items) {\n  const root = item.json || {};\n\n  // n8n di solito mette l'errore in root.error\n  const error = root.error;\n  // e l'item originale o in root.json o direttamente in root\n  const original = root.json || root;\n\n  // Se per qualche motivo non c'è errore, rimando solo l'originale\n  if (!error) {\n    results.push({ json: original });\n    continue;\n  }\n\n  const attempts = Number(original.publish_attempts || 0);\n  const statusCode = String(error.statusCode || error.code || '');\n  const message = error.message || '';\n\n  // Caso 1: evento CANCELLATO dal calendario (404 / not found)\n  const isNotFound =\n    statusCode === '404' ||\n    /not.?found/i.test(message);\n\n  if (isNotFound) {\n    results.push({\n      json: {\n        ...original,\n        status: 'CANCELLED',                 // non più schedulato\n        calendar_event_id: '',              // sgancio dal calendario\n        publish_attempts: String(attempts + 1),\n        error_message: message || 'Calendar event deleted'\n        // NOTA: non tocco approval_flag, resta com'era (es. APPROVED)\n      }\n    });\n  } else {\n    // Caso 2: errore tecnico di calendario\n    results.push({\n      json: {\n        ...original,\n        status: 'ERROR',\n        // qui puoi decidere se lasciare o togliere l'event_id\n        // io lo lascerei, così puoi riprovare più tardi\n        calendar_event_id: original.calendar_event_id,\n        publish_attempts: String(attempts + 1),\n        error_message: message || 'Calendar sync error'\n        // anche qui: NON tocco approval_flag\n      }\n    });\n  }\n}\n\nreturn results;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        672,
        -1776
      ],
      "id": "6f6e96cc-623b-4632-93ac-5e6fb511dae3",
      "name": "Set PUBLISHING ERRORS1"
    },
    {
      "parameters": {
        "jsCode": "// Tagga l'ID di riga dello Sheet prima di toccare i social\nconst items = $input.all();\n\nreturn items.map(item => {\n  const json = item.json;\n  json.sheet_id = json.id;   // id riga foglio\n  return item;\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        384,
        -896
      ],
      "id": "ee1ccd4f-5729-40af-a99e-b61a0fc385e2",
      "name": "Tag Sheet ID"
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition",
        "options": {}
      },
      "name": "Merge FB text",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [
        1600,
        -1408
      ],
      "id": "1f65ccac-f24c-4b03-b965-19a61b228b04"
    },
    {
      "parameters": {
        "httpRequestMethod": "POST",
        "graphApiVersion": "v23.0",
        "node": "<PUT HERE YOUR FACEBOOK PAGE ID>",
        "edge": "feed",
        "options": {
          "queryParameters": {
            "parameter": [
              {
                "name": "message",
                "value": "={{ $json.post_text + '\\n\\n' + $json.hashtags }}"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.facebookGraphApi",
      "typeVersion": 1,
      "position": [
        1344,
        -1408
      ],
      "id": "8660db8b-5ad2-488d-9b25-e3d5fe8733fa",
      "name": "Facebook Publish Text",
      "credentials": {
        "facebookGraphApi": {
          "id": "<<PUT HERE YOUR REDENTIAL_ID>",
          "name": "Facebook Graph account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "jsCode": "// Normalize Data v2 - Media Comuni\n// Con normalizzazione robusta numeri telefono e date\n\nfunction simpleUUID() {\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n    const r = (Math.random() * 16) | 0;\n    const v = c === 'x' ? r : (r & 0x3) | 0x8;\n    return v.toString(16);\n  });\n}\n\n// ═══════════════════════════════════════════════════════════════════════════\n// NORMALIZZAZIONE DATE\n// ═══════════════════════════════════════════════════════════════════════════\n// Supporta:\n// - 31/12/2025\n// - 31/12/2025 10:30\n// - 31/12/2025 1:30:00\n// - 31-12-2025 10:30\n// - 31.12.2025 10.30\n// - 2025-12-31T10:30:00\n// - 2025-12-31 10:30\n// - 31 dicembre 2025 10:30\n\nfunction parseDate(dateStrRaw) {\n  if (!dateStrRaw) return null;\n  \n  let str = String(dateStrRaw).trim();\n  if (!str) return null;\n\n  // Normalizza separatori: . e - → /\n  // Ma attenzione a non toccare il formato ISO\n  \n  // Prima prova: formato ISO (2025-12-31T10:30:00 o 2025-12-31 10:30)\n  const isoMatch = str.match(/^(\\d{4})-(\\d{1,2})-(\\d{1,2})(?:[T\\s](\\d{1,2})[:\\.](\\d{2})(?:[:\\.](\\d{2}))?)?/);\n  if (isoMatch) {\n    const year = Number(isoMatch[1]);\n    const month = Number(isoMatch[2]);\n    const day = Number(isoMatch[3]);\n    const hour = Number(isoMatch[4] || '0');\n    const minute = Number(isoMatch[5] || '0');\n    \n    if (isValidDate(year, month, day, hour, minute)) {\n      return formatIsoDate(year, month, day, hour, minute);\n    }\n  }\n\n  // Normalizza separatori per formato italiano\n  // Sostituisce . e - con / per la data\n  // Sostituisce . con : per l'ora\n  str = str\n    .replace(/(\\d{1,2})[\\.\\-](\\d{1,2})[\\.\\-](\\d{4})/, '$1/$2/$3')  // data\n    .replace(\n      /(\\d{1,2})\\.(\\d{2})(?:\\.(\\d{2}))?(?=\\s*$|$)/,\n      (match, h, m, s) => s ? `${h}:${m}:${s}` : `${h}:${m}`\n    );\n\n\n  // Formato italiano: GG/MM/AAAA [HH:MM[:SS]]\n  const italianMatch = str.match(\n    /^(\\d{1,2})\\/(\\d{1,2})\\/(\\d{4})(?:\\s+(\\d{1,2}):(\\d{2})(?::(\\d{2}))?)?$/\n  );\n\n  if (italianMatch) {\n    const day = Number(italianMatch[1]);\n    const month = Number(italianMatch[2]);\n    const year = Number(italianMatch[3]);\n    const hour = Number(italianMatch[4] || '0');\n    const minute = Number(italianMatch[5] || '0');\n\n    if (isValidDate(year, month, day, hour, minute)) {\n      return formatIsoDate(year, month, day, hour, minute);\n    }\n  }\n\n  // Formato con mese testuale: 31 dicembre 2025 10:30\n  const monthNames = {\n    'gennaio': 1, 'gen': 1,\n    'febbraio': 2, 'feb': 2,\n    'marzo': 3, 'mar': 3,\n    'aprile': 4, 'apr': 4,\n    'maggio': 5, 'mag': 5,\n    'giugno': 6, 'giu': 6,\n    'luglio': 7, 'lug': 7,\n    'agosto': 8, 'ago': 8,\n    'settembre': 9, 'set': 9,\n    'ottobre': 10, 'ott': 10,\n    'novembre': 11, 'nov': 11,\n    'dicembre': 12, 'dic': 12\n  };\n\n  const textMatch = str.toLowerCase().match(\n    /^(\\d{1,2})\\s+([a-zàèéìòù]+)\\s+(\\d{4})(?:\\s+(\\d{1,2})[:\\.](\\d{2}))?$/\n  );\n\n  if (textMatch) {\n    const day = Number(textMatch[1]);\n    const monthName = textMatch[2];\n    const year = Number(textMatch[3]);\n    const hour = Number(textMatch[4] || '0');\n    const minute = Number(textMatch[5] || '0');\n    const month = monthNames[monthName];\n\n    if (month && isValidDate(year, month, day, hour, minute)) {\n      return formatIsoDate(year, month, day, hour, minute);\n    }\n  }\n\n  // Fallback: prova parsing nativo JavaScript\n  const d = new Date(str);\n  if (!Number.isNaN(d.getTime())) {\n    return d.toISOString();\n  }\n\n  return null;\n}\n\nfunction isValidDate(year, month, day, hour, minute) {\n  return (\n    year >= 1970 && year <= 2100 &&\n    month >= 1 && month <= 12 &&\n    day >= 1 && day <= 31 &&\n    hour >= 0 && hour <= 23 &&\n    minute >= 0 && minute <= 59\n  );\n}\n\nfunction formatIsoDate(year, month, day, hour, minute) {\n  const yyyy = String(year).padStart(4, '0');\n  const MM = String(month).padStart(2, '0');\n  const dd = String(day).padStart(2, '0');\n  const HH = String(hour).padStart(2, '0');\n  const mm = String(minute).padStart(2, '0');\n  return `${yyyy}-${MM}-${dd}T${HH}:${mm}:00`;\n}\n\n// ═══════════════════════════════════════════════════════════════════════════\n/* NORMALIZZAZIONE NUMERI TELEFONO WHATSAPP */\n// ═══════════════════════════════════════════════════════════════════════════\n// Supporta:\n// - +39 333 1234567\n// - 0039 333 1234567\n// - 0039-333-1234567\n// - 333 123 4567\n// - 3331234567\n// - +39333123456, +39444555666\n// - 333123456 , 444555666\n// - 333123456,444555666,555666777\n\nfunction normalizePhoneNumbers(phonesRaw) {\n  if (!phonesRaw) return { normalized: '', isValid: true, errors: [] };\n\n  const rawStr = String(phonesRaw).trim();\n  if (!rawStr) return { normalized: '', isValid: true, errors: [] };\n\n  // Split per virgola (con gestione spazi multipli)\n  const rawNumbers = rawStr.split(/\\s*,\\s*/);\n  \n  const normalizedNumbers = [];\n  const errors = [];\n\n  for (let raw of rawNumbers) {\n    // Rimuovi tutti gli spazi, trattini, parentesi, punti\n    let num = raw.replace(/[\\s\\-\\(\\)\\.]/g, '');\n    \n    if (!num) continue; // Salta stringhe vuote\n\n    // Gestione prefisso internazionale\n    if (num.startsWith('+')) {\n      // Già con +, ok\n    } else if (num.startsWith('00')) {\n      // 0039... → +39...\n      num = '+' + num.substring(2);\n    } else if (num.startsWith('0') && num.length > 9) {\n      // Numero italiano con 0 iniziale (es. 0333...) - rimuovi lo 0 e aggiungi +39\n      num = '+39' + num.substring(1);\n    } else if (/^\\d{9,10}$/.test(num)) {\n      // Numero senza prefisso (es. 3331234567) - aggiungi +39\n      num = '+39' + num;\n    } else if (/^\\d+$/.test(num)) {\n      // Altri numeri solo cifre - prova ad aggiungere +39\n      num = '+39' + num;\n    } else {\n      // Formato non riconosciuto\n      errors.push(`Formato non valido: \"${raw}\"`);\n      continue;\n    }\n\n    // Validazione finale: deve essere +[codice paese][numero]\n    // Lunghezza tipica: +39XXXXXXXXXX (12-13 caratteri per Italia)\n    // Range generico: 10-16 cifre totali dopo il +\n    if (/^\\+\\d{10,15}$/.test(num)) {\n      normalizedNumbers.push(num);\n    } else {\n      errors.push(`Numero non valido: \"${raw}\" → \"${num}\"`);\n    }\n  }\n\n  return {\n    normalized: normalizedNumbers.join(','),\n    isValid: errors.length === 0 && normalizedNumbers.length > 0,\n    errors: errors,\n    count: normalizedNumbers.length\n  };\n}\n\n// ═══════════════════════════════════════════════════════════════════════════\n// PARSING SCELTA MEDIA\n// ═══════════════════════════════════════════════════════════════════════════\n// Supporta le opzioni del form:\n// - \"Immagine\"\n// - \"Video\"\n// - \"Solo testo\"  → nessun media\n// immagine personale\n// video personale\n\nfunction parseMediaChoice(mediaChoice) {\n  if (!mediaChoice) return 'none';\n  const choice = mediaChoice.toLowerCase().trim();\n  \n  if (choice.includes('immagine personale')) return 'personal_image';\n  if (choice.includes('video personale')) return 'personal_video';\n  if (choice.includes('immagine')) return 'common_image';\n  if (choice.includes('video')) return 'common_video';\n  if (choice.includes('solo testo')) return 'none';\n  return 'none';\n}\n\n// ═══════════════════════════════════════════════════════════════════════════\n// MAIN PROCESSING\n// ═══════════════════════════════════════════════════════════════════════════\n\nconst results = [];\nconst items = $input.all();\n\nfor (let index = 0; index < items.length; index++) {\n  const item = items[index];\n  const json = item.json;\n\n  // Salta già importati\n  if (json.import_status && json.import_status !== 'NEW') {\n    continue;\n  }\n\n  const sessionId = simpleUUID();\n\n  // ─────────────────────────────────────────────────────────────────────────\n  // ESTRAI INFO MEDIA COMUNI\n  // ─────────────────────────────────────────────────────────────────────────\n  \n  const generateImage = (json['Vuoi pubblicare un\\'immagine?'] || '').toLowerCase() === 'sì';\n  const imagePrompt = json['Descrizione immagine:'] || '';\n  const generateVideo = (json['Vuoi pubblicare un video?'] || '').toLowerCase() === 'sì';\n  const videoPrompt = json['Descrizione video'] || '';\n\n  // ─────────────────────────────────────────────────────────────────────────\n  // CAMPI COMUNI SESSIONE\n  // ─────────────────────────────────────────────────────────────────────────\n  const personalImageDriveUrl = json['Carica la tua immagine'] || '';\n  const personalVideoDriveUrl = json['Carica il tuo video'] || '';\n  \n  const commonFields = {\n    session_id: sessionId,\n    user_email: json['Indirizzo email'] || '',\n    campaign_title: json['Titolo campagna'] || '',\n    \n    // Media comuni - stato iniziale\n    generate_common_image: generateImage,\n    common_image_prompt: imagePrompt,\n    common_image_status: generateImage ? 'PENDING' : 'NOT_REQUESTED',\n    common_image_url: '',\n    \n    generate_common_video: generateVideo,\n    common_video_prompt: videoPrompt,\n    common_video_status: generateVideo ? 'PENDING' : 'NOT_REQUESTED',\n    common_video_url: '',\n\n    // media personali da Google Drive\n    personal_image_url_drive: personalImageDriveUrl,\n    personal_video_url_drive: personalVideoDriveUrl,\n    \n    import_source_row: json.source_row || json.rowNumber || index + 2,\n  };\n\n  // ─────────────────────────────────────────────────────────────────────────\n  // DEFINIZIONE PIATTAFORME CON MAPPING COLONNE\n  // ─────────────────────────────────────────────────────────────────────────\n  \n  const platforms = [\n    { \n      key: 'facebook', \n      label: 'Facebook',\n      textCol: 'Testo del post Facebook',\n      hashtagCol: 'Hashtag Facebook',\n      mediaCol: 'Media da utilizzare Facebook',\n      dateCol: 'Data e ora pubblicazione Facebook'\n    },\n    { \n      key: 'instagram', \n      label: 'Instagram',\n      textCol: 'Testo del post Instagram',\n      hashtagCol: 'Hashtag Instagram',\n      mediaCol: 'Media da utilizzare Instagram',\n      dateCol: 'Data e ora pubblicazione Instagram'\n    },\n    { \n      key: 'tiktok', \n      label: 'TikTok',\n      textCol: 'Testo del post TikTok',\n      hashtagCol: 'Hashtag TikTok',\n      mediaCol: 'Media da utilizzare TikTok',\n      dateCol: 'Data e ora pubblicazione TikTok'\n    },\n    { \n      key: 'youtube', \n      label: 'YouTube',\n      textCol: 'Testo del post YouTube',\n      hashtagCol: 'Hashtag YouTube',\n      mediaCol: 'Media da utilizzare YouTube',\n      dateCol: 'Data e ora pubblicazione YouTube'\n    },\n    { \n      key: 'whatsapp', \n      label: 'WhatsApp',\n      textCol: 'Testo del post WhatsApp',\n      hashtagCol: 'Hashtag WhatsApp',\n      mediaCol: 'Media da utilizzare WhatsApp',\n      dateCol: 'Data e ora pubblicazione WhatsApp',\n      phoneCol: 'Destinatari WhatsApp (separati da una virgola)'\n    },\n    { \n      key: 'x', \n      label: 'X',\n      textCol: 'Testo del post X',\n      hashtagCol: 'Hashtag X/Twitter',\n      mediaCol: 'Media da utilizzare X',\n      dateCol: 'Data e ora pubblicazione X'\n    },\n  ];\n\n  // ─────────────────────────────────────────────────────────────────────────\n  // ESTRAI PIATTAFORME SELEZIONATE\n  // ─────────────────────────────────────────────────────────────────────────\n  \n  const selectedPlatformsRaw = json['Su quali piattaforme vuoi pubblicare?'] || '';\n  const selectedPlatforms = selectedPlatformsRaw\n    .toLowerCase()\n    .split(',')\n    .map(p => p.trim());\n\n  // ─────────────────────────────────────────────────────────────────────────\n  // PROCESSA OGNI PIATTAFORMA\n  // ─────────────────────────────────────────────────────────────────────────\n  \n  for (const p of platforms) {\n    \n    // Verifica se piattaforma è selezionata\n    const isSelected = selectedPlatforms.some(sel => \n      sel.includes(p.key) || \n      sel.includes(p.label.toLowerCase()) ||\n      (p.key === 'x' && (sel.includes('twitter') || sel.includes('x (') || sel === 'x'))\n    );\n    \n    if (!isSelected) continue;\n\n    // Verifica se ha contenuto (almeno testo o media)\n    const hasText = !!(json[p.textCol] || '').trim();\n    const hasMedia = !!(json[p.mediaCol] || '').trim();\n    \n    // Se non ha né testo né selezione media, salta\n    if (!hasText && !hasMedia) continue;\n\n    const row = {\n      ...commonFields,\n      id: `${sessionId}_${p.key}`,\n      platform: p.key,\n      post_text: (json[p.textCol] || '').trim(),\n      hashtags: (json[p.hashtagCol] || '').trim(),\n      status: 'NEW',\n      approval_flag: 'PENDING',\n      publish_attempts: '0', // tenuto sempre come stringa\n      target_phone_number: '',\n      public_url: '',\n      local_path: '',\n      final_filename: '',\n      remote_filename: '',\n      remotePath: '',\n      local_full_path: '',\n      remote_full_path: '',\n      error_message: '',\n      calendar_event_id: '',\n    };\n\n    // ─────────────────────────────────────────────────────────────────────\n    // DETERMINAZIONE TIPO E VARIANTE MEDIA (UNIFICATA)\n    // ─────────────────────────────────────────────────────────────────────\n    \n    const mediaChoice = json[p.mediaCol] || '';\n    row.media_source = parseMediaChoice(mediaChoice);\n\n    if (row.media_source === 'personal_image' || row.media_source === 'common_image') {\n      row.media_type = 'image';\n      row.media_variant = 'feed';\n      if (row.media_source === 'personal_image') {\n        row.drive_url = commonFields.personal_image_url_drive;\n      }\n    } \n    else if (row.media_source === 'personal_video' || row.media_source === 'common_video') {\n      row.media_type = 'video';\n      // Imposta 'short' per YouTube/TikTok, altrimenti 'feed'\n      row.media_variant = (p.key === 'youtube' || p.key === 'tiktok') ? 'short' : 'feed';\n      \n      if (row.media_source === 'personal_video') {\n        row.drive_url = commonFields.personal_video_url_drive;\n      }\n    } \n    else {\n      row.media_type = 'none';\n      row.media_variant = 'none';\n    }\n\n    // ─────────────────────────────────────────────────────────────────────\n    // VALIDAZIONI MEDIA\n    // ─────────────────────────────────────────────────────────────────────\n    \n    // Instagram richiede sempre media\n    if (p.key === 'instagram' && row.media_type === 'none') {\n      row.status = 'ERROR';\n      row.approval_flag = 'REJECTED';\n      row.error_message = 'Instagram richiede obbligatoriamente un media (immagine o video)';\n    }\n\n    // YouTube richiede video\n    if (p.key === 'youtube' && row.media_type !== 'video') {\n      row.status = 'ERROR';\n      row.approval_flag = 'REJECTED';\n      row.error_message = 'YouTube richiede obbligatoriamente un video';\n    }\n\n    // Media richiesto ma non generato\n    if (row.media_source === 'common_image' && !generateImage) {\n      row.status = 'ERROR';\n      row.approval_flag = 'REJECTED';\n      row.error_message = 'Selezionata \"Immagine comune\" ma generazione immagine non richiesta';\n    }\n    if (row.media_source === 'common_video' && !generateVideo) {\n      row.status = 'ERROR';\n      row.approval_flag = 'REJECTED';\n      row.error_message = 'Selezionato \"Video comune\" ma generazione video non richiesta';\n    }\n\n    // ─────────────────────────────────────────────────────────────────────\n    // NORMALIZZAZIONE DATA E ORA\n    // ─────────────────────────────────────────────────────────────────────\n    \n    const dateStrRaw = json[p.dateCol];\n    const parsedDate = parseDate(dateStrRaw);\n\n    if (parsedDate) {\n      row.scheduled_time = parsedDate;\n      row.publish_mode = 'SCHEDULED';\n    } else {\n      row.scheduled_time = null;\n      row.publish_mode = 'IMMEDIATE_AFTER_APPROVAL';\n    }\n\n    // ─────────────────────────────────────────────────────────────────────\n    // WHATSAPP: NORMALIZZAZIONE NUMERI TELEFONO\n    // ─────────────────────────────────────────────────────────────────────\n    \n    if (p.key === 'whatsapp') {\n      const phonesRaw = json[p.phoneCol] || '';\n      const phoneResult = normalizePhoneNumbers(phonesRaw);\n      \n      row.target_phone_number = phoneResult.normalized;\n      \n      // Validazione\n      if (phonesRaw && !phoneResult.normalized) {\n        row.status = 'ERROR';\n        row.approval_flag = 'REJECTED';\n        row.error_message = 'Nessun numero di telefono valido trovato';\n      } else if (phoneResult.errors.length > 0) {\n        // Alcuni numeri non validi, ma altri sì\n        if (row.status !== 'ERROR') {\n          row.error_message = `Attenzione: ${phoneResult.errors.join('; ')}`;\n        }\n      } else if (!phonesRaw) {\n        row.status = 'ERROR';\n        row.approval_flag = 'REJECTED';\n        row.error_message = 'WhatsApp richiede almeno un destinatario';\n      }\n    }\n\n    results.push({ json: row });\n  }\n}\n\nreturn results;\n"
      },
      "name": "Normalize Data1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        144,
        -3376
      ],
      "id": "a7abf02c-6b5c-45ec-b989-7b4b5c980b4b"
    },
    {
      "parameters": {
        "dataType": "string",
        "value1": "={{ $json.media_type }}",
        "rules": {
          "rules": [
            {
              "value2": "video"
            },
            {
              "value2": "image",
              "output": 1
            }
          ]
        },
        "fallbackOutput": 1
      },
      "name": "Switch Media Type1",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [
        1424,
        -3424
      ],
      "id": "4f3bf19c-2a2b-4381-b6a7-b07c346d1570"
    },
    {
      "parameters": {
        "resource": "video",
        "modelId": {
          "__rl": true,
          "value": "sora-2-pro",
          "mode": "list",
          "cachedResultName": "SORA-2-PRO"
        },
        "prompt": "={{ $json.prompt }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2,
      "position": [
        1616,
        -3568
      ],
      "name": "OpenAI Video Gen1",
      "id": "5973c879-75b6-439b-93a8-7a817bb174f1",
      "credentials": {
        "openAiApi": {
          "id": "<PUT HERE YOUR_CREDENTIALS_ID>",
          "name": "OpenAi account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "resource": "image",
        "prompt": "={{ $json.prompt }}",
        "model": "dall-e-3",
        "options": {
          "n": 1
        },
        "requestOptions": {}
      },
      "name": "OpenAI Image Gen1",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1,
      "position": [
        1568,
        -3184
      ],
      "id": "2ced6ea5-22c8-4138-989c-3cace81457e4",
      "credentials": {
        "openAiApi": {
          "id": "<PUT HERE YOUR_CREDENTIALS_ID>",
          "name": "OpenAi account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition",
        "options": {}
      },
      "name": "Merge Video Data1",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [
        1824,
        -3568
      ],
      "id": "2cdb4679-7f3d-49fe-9aea-b73f63316b0f"
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition",
        "options": {}
      },
      "name": "Merge Image Data1",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [
        1824,
        -3184
      ],
      "id": "12bab89d-1261-455e-874c-c47e2d052b04"
    },
    {
      "parameters": {
        "jsCode": "// Calculate Paths – versione con local_path = directory e final_filename separato\n\nfunction simpleUUID() {\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n    const r = (Math.random() * 16) | 0;\n    const v = c === 'x' ? r : (r & 0x3) | 0x8;\n    return v.toString(16);\n  });\n}\n\nconst items = $input.all();\n\nreturn items.map((item) => {\n  const json = item.json;\n\n  // Se a monte c'è stato un errore, non tocco l'item\n  if (json.error) {\n    return item;\n  }\n\n  const platform = json.platform || 'common';\n  const id = json.id ?? 'unknown';\n\n  const mediaId = simpleUUID().split('-')[0];\n  const isVideo = json.media_type === 'video';\n  const ext = isVideo ? 'mp4' : 'png';\n\n  const timestamp = new Date()\n    .toISOString()\n    .replace(/[-:T]/g, '')\n    .slice(0, 12);\n\n  const filename = `${platform}_${timestamp}_${id}_${mediaId}.${ext}`;\n\n  // Metto la / finale così sei sicuro che sia una directory\n  const localDir = `<PUT HERE YOUR LOCAL PATH>/${platform}/`;\n  const remoteDir = `<PUT HERE YOUR REMOTE DIR>/${platform}/`;\n\n  // 🔹 Sullo sheet:\n  json.final_filename = filename;      // solo nome file\n  json.local_path = localDir;          // solo directory locale\n  json.remote_filename = filename;    // solo nome file\n  json.public_url = `<PUT HERE YOUR FTP DOMAIN>/${platform}/${filename}`;\n  json.remotePath = remoteDir;         // solo path remoto\n  // 🔹 Comodi per i nodi successivi (non serve che siano colonne sullo sheet)\n  json.local_full_path = localDir + filename;\n  json.remote_full_path = remoteDir + filename;\n\n  return item;\n});\n"
      },
      "name": "Calculate Paths1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        2064,
        -3424
      ],
      "id": "c0ede6fd-13e1-4fec-9305-9f274b812a12"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.error ? true : false }}",
              "value2": true
            }
          ]
        }
      },
      "name": "Check Gen Error1",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        2272,
        -3424
      ],
      "id": "d4384f50-f116-4fe0-8212-c5a972e3ddfd"
    },
    {
      "parameters": {
        "fileName": "=/tmp/{{ $json.final_filename }}",
        "options": {}
      },
      "name": "Save to Local Disk1",
      "type": "n8n-nodes-base.writeBinaryFile",
      "typeVersion": 1,
      "position": [
        2544,
        -3408
      ],
      "id": "62eb7233-4e43-41d4-9899-fc68f2a5c605"
    },
    {
      "parameters": {
        "operation": "upload",
        "path": "={{ $json.remote_full_path }}"
      },
      "name": "FTP Upload1",
      "type": "n8n-nodes-base.ftp",
      "typeVersion": 1,
      "position": [
        2544,
        -3200
      ],
      "id": "fa0f4a09-cea5-4834-aa18-f099f1952c72",
      "credentials": {
        "ftp": {
          "id": "<PUT HERE YOUR_CREDENTIALS_ID>",
          "name": "FTP account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst sessions = {};\n\nfor (const item of items) {\n  const json = item.json;\n  const sid = json.session_id;\n  if (!sessions[sid]) sessions[sid] = [];\n  sessions[sid].push(json);\n}\n\nconst result = [];\nfor (const sid in sessions) {\n  result.push({\n    json: {\n      session_id: sid,\n      user_email: sessions[sid][0].user_email,\n      posts: sessions[sid]\n    }\n  });\n}\nreturn result;"
      },
      "name": "Group by Session1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        2304,
        -2976
      ],
      "id": "c3cdc931-9c76-438f-8f2c-683f43deef73"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "<PUT HERE YOUR GOOGLE SHEET ID>",
          "mode": "list",
          "cachedResultName": "Social_Media_Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 842035569,
          "mode": "list",
          "cachedResultName": "Risposte_del_modulo",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit#gid=842035569"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -48,
        -3376
      ],
      "id": "849ca96e-b5c8-4c78-800b-7a1ca4675140",
      "name": "Read Form Responses1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "<PUT HERE YOUR_CREDENTIALS_ID>",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "<PUT HERE YOUR GOOGLE SHEET ID>",
          "mode": "list",
          "cachedResultName": "Social_Media_Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Variabili_di_input-output",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit#gid=0"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {},
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "import_source_row",
              "displayName": "import_source_row",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_email",
              "displayName": "user_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "campaign_title",
              "displayName": "campaign_title",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "platform",
              "displayName": "platform",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "post_text",
              "displayName": "post_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hashtags",
              "displayName": "hashtags",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "media_source",
              "displayName": "media_source",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "media_type",
              "displayName": "media_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "media_variant",
              "displayName": "media_variant",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "scheduled_time",
              "displayName": "scheduled_time",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "publish_mode",
              "displayName": "publish_mode",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "target_phone_number",
              "displayName": "target_phone_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "approval_flag",
              "displayName": "approval_flag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "generate_common_image",
              "displayName": "generate_common_image",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "common_image_prompt",
              "displayName": "common_image_prompt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "common_image_status",
              "displayName": "common_image_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "common_image_url",
              "displayName": "common_image_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "generate_common_video",
              "displayName": "generate_common_video",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "common_video_prompt",
              "displayName": "common_video_prompt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "common_video_status",
              "displayName": "common_video_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "common_video_url",
              "displayName": "common_video_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "public_url",
              "displayName": "public_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "local_path",
              "displayName": "local_path",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "saved_locally",
              "displayName": "saved_locally",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "final_filename",
              "displayName": "final_filename",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "remote_filename",
              "displayName": "remote_filename",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "remotePath",
              "displayName": "remotePath",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "local_full_path",
              "displayName": "local_full_path",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "remote_full_path",
              "displayName": "remote_full_path",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "publish_attempts",
              "displayName": "publish_attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "error_message",
              "displayName": "error_message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "calendar_event_id",
              "displayName": "calendar_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "id_image",
              "displayName": "id_image",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        352,
        -3376
      ],
      "id": "6f2865d9-aa27-4d73-81aa-a0d7911a3202",
      "name": "Write to Output Sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "<PUT HERE YOUR_CREDENTIALS_ID>",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Build Approval Email v2 - Con media comuni\n\nconst baseUrl = '/<PUT HERE YOUR CLOUDFLARE TUNNEL/webhook/social_approval';\nconst items = $input.all();\n\nreturn items.map(item => {\n  const { session_id, user_email } = item.json;\n  const allPosts = item.json.posts || [];\n\n  const posts = allPosts.filter(p =>\n    (p.approval_flag === 'PENDING' || !p.approval_flag)\n  );\n\n  // Estrai info media comuni (dal primo post)\n  const firstPost = allPosts[0] || {};\n  const commonImageUrl = firstPost.common_image_url || '';\n  const commonVideoUrl = firstPost.common_video_url || '';\n\n  // Sezione preview media comuni\n  let mediaPreviewHtml = '<h3>Media Comuni Generati</h3>';\n  \n  if (commonImageUrl) {\n    mediaPreviewHtml += `\n      <div style=\"margin-bottom: 20px;\">\n        <strong>🖼️ Immagine Comune:</strong><br/>\n        <img src=\"${commonImageUrl}\" alt=\"Immagine comune\" \n             style=\"max-width:300px; max-height:300px; display:block; margin-top:8px; border:1px solid #ddd;\" />\n        <a href=\"${commonImageUrl}\" target=\"_blank\">[Apri immagine]</a>\n      </div>\n    `;\n  }\n  \n  if (commonVideoUrl) {\n    mediaPreviewHtml += `\n      <div style=\"margin-bottom: 20px;\">\n        <strong>🎬 Video Comune:</strong><br/>\n        <a href=\"${commonVideoUrl}\" target=\"_blank\">[Guarda video]</a>\n      </div>\n    `;\n  }\n  \n  if (!commonImageUrl && !commonVideoUrl) {\n    mediaPreviewHtml += '<p><em>Nessun media comune generato</em></p>';\n  }\n\n  // Tabella post\n  const rowsHtml = posts.map(p => {\n    const id = p.id || '';\n    const platform = p.platform || '';\n    const text = (p.post_text || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');\n    const scheduled = p.scheduled_time || 'IMMEDIATO';\n    const mediaSource = p.media_source || 'none';\n    \n    let mediaLabel = '(Nessun media)';\n    if (mediaSource === 'common_image') mediaLabel = '🖼️ Immagine comune';\n    if (mediaSource === 'common_video') mediaLabel = '🎬 Video comune';\n\n    const approveOne = `${baseUrl}?session_id=${encodeURIComponent(session_id)}&id=${encodeURIComponent(id)}&action=approve_one`;\n    const rejectOne = `${baseUrl}?session_id=${encodeURIComponent(session_id)}&id=${encodeURIComponent(id)}&action=reject_one`;\n\n    return `\n      <tr>\n        <td>${platform.toUpperCase()}</td>\n        <td>${scheduled}</td>\n        <td>${text}</td>\n        <td>${mediaLabel}</td>\n        <td>\n          <a href=\"${approveOne}\">✅ Approva</a> |\n          <a href=\"${rejectOne}\">❌ Rifiuta</a>\n        </td>\n      </tr>\n    `;\n  }).join('');\n\n  const approveAll = `${baseUrl}?session_id=${encodeURIComponent(session_id)}&action=approve_all`;\n  const rejectAll = `${baseUrl}?session_id=${encodeURIComponent(session_id)}&action=reject_all`;\n  const campaignTitle = firstPost.campaign_title || '';\n\n  const html = `\n    <h2>Campagna: ${campaignTitle}</h2>\n    <p>Ci sono <strong>${posts.length} post</strong> da approvare.</p>\n    \n    ${mediaPreviewHtml}\n    \n    <h3>Dettaglio Post</h3>\n    <table border=\"1\" cellpadding=\"8\" cellspacing=\"0\" style=\"border-collapse: collapse;\">\n      <tr style=\"background-color: #f0f0f0;\">\n        <th>Piattaforma</th>\n        <th>Orario</th>\n        <th>Testo</th>\n        <th>Media</th>\n        <th>Azioni</th>\n      </tr>\n      ${rowsHtml}\n    </table>\n    \n    <p style=\"margin-top: 20px;\">\n      <a href=\"${approveAll}\" style=\"background:#28a745;color:white;padding:10px 20px;text-decoration:none;border-radius:4px;\">✅ APPROVA TUTTI</a>\n      &nbsp;&nbsp;\n      <a href=\"${rejectAll}\" style=\"background:#dc3545;color:white;padding:10px 20px;text-decoration:none;border-radius:4px;\">❌ RIFIUTA TUTTI</a>\n    </p>\n  `;\n\n  item.json.email_body = html;\n  item.json.user_email = user_email;\n\n  return item;\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2496,
        -2976
      ],
      "id": "a962db5c-ef28-4df3-aec9-fb12dc6a3700",
      "name": "Build Approval Email1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2128,
        -2976
      ],
      "id": "9d4679c8-54fd-4593-90a3-e50db6925cc1",
      "name": "Merge1"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "<PUT HERE YOUR GOOGLE SHEET ID>",
          "mode": "list",
          "cachedResultName": "Social_Media_Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Variabili_di_input-output",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit#gid=0"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {
            "row_number": 0
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "import_source_row",
              "displayName": "import_source_row",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_email",
              "displayName": "user_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "campaign_title",
              "displayName": "campaign_title",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "platform",
              "displayName": "platform",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "post_text",
              "displayName": "post_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hashtags",
              "displayName": "hashtags",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "media_source",
              "displayName": "media_source",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "media_type",
              "displayName": "media_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "media_variant",
              "displayName": "media_variant",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "scheduled_time",
              "displayName": "scheduled_time",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "publish_mode",
              "displayName": "publish_mode",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "target_phone_number",
              "displayName": "target_phone_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "approval_flag",
              "displayName": "approval_flag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "generate_common_image",
              "displayName": "generate_common_image",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "common_image_prompt",
              "displayName": "common_image_prompt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "common_image_status",
              "displayName": "common_image_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "common_image_url",
              "displayName": "common_image_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "generate_common_video",
              "displayName": "generate_common_video",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "common_video_prompt",
              "displayName": "common_video_prompt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "common_video_status",
              "displayName": "common_video_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "common_video_url",
              "displayName": "common_video_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "public_url",
              "displayName": "public_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "local_path",
              "displayName": "local_path",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "saved_locally",
              "displayName": "saved_locally",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "final_filename",
              "displayName": "final_filename",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "remote_filename",
              "displayName": "remote_filename",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "remotePath",
              "displayName": "remotePath",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "local_full_path",
              "displayName": "local_full_path",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "remote_full_path",
              "displayName": "remote_full_path",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "publish_attempts",
              "displayName": "publish_attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "error_message",
              "displayName": "error_message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "calendar_event_id",
              "displayName": "calendar_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1936,
        -2960
      ],
      "id": "73dc0315-8e46-40bd-8186-52c23ad852b2",
      "name": "Update Sheet (Media – Ready for Approval)1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "<PUT HERE YOUR_CREDENTIALS_ID>",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nreturn items.map(item => {\n  const json = item.json;\n\n  if (json.status !== 'ERROR') {\n    json.status = 'READY_FOR_APPROVAL';\n    // se vuoi, resetta solo se era vuoto\n    json.error_message = json.error_message || '';\n  }\n\n  json.id_image = json.final_filename || '';\n\n  return item;\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1776,
        -2960
      ],
      "id": "3d89e764-ddd1-4af2-85bc-4fc8635bd8ec",
      "name": "Mark Media Ready For Approval1"
    },
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "documentId": {
          "__rl": true,
          "value": "<PUT HERE YOUR GOOGLE SHEET ID>",
          "mode": "list",
          "cachedResultName": "Social_Media_Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 842035569,
          "mode": "list",
          "cachedResultName": "Risposte_del_modulo",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit#gid=842035569"
        },
        "event": "rowAdded",
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheetsTrigger",
      "typeVersion": 1,
      "position": [
        -256,
        -3376
      ],
      "id": "8def9ea6-0740-4f8f-9515-41e51c9c06cc",
      "name": "Google Sheets Trigger1",
      "credentials": {
        "googleSheetsTriggerOAuth2Api": {
          "id": "<<PUT HERE YOUR REDENTIAL_ID>",
          "name": "Google Sheets Trigger account"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "={{ $json.user_email }}",
        "subject": "Approval Required: Social Media Posts",
        "message": "={{ $json.email_body }}",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        2704,
        -2976
      ],
      "id": "bfab64d0-511f-4913-a140-880a6a7e2b85",
      "name": "Send a message1",
      "webhookId": "<PUT HERE YOUR WEBHOOK_ID>",
      "credentials": {
        "gmailOAuth2": {
          "id": "<<PUT HERE YOUR REDENTIAL_ID>",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "authentication": "privateKey",
        "command": "=docker cp n8n:/tmp/{{ $json.final_filename }} {{ $json.local_full_path }}"
      },
      "id": "07a7856d-9387-4dee-ae63-233a60b10e45",
      "name": "SSH Host Sync1",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        2544,
        -3600
      ],
      "credentials": {
        "sshPrivateKey": {
          "id": "<<PUT HERE YOUR REDENTIAL_ID>",
          "name": "SSH Private Key account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "jsCode": "// Assign Media URLs to Posts v3\n// - Usa mediaBySession dall'Aggregate\n// - Uniforma i path locali su <PUT HERE YOUR LOCAL PATH>/\n// - Propaga filename + path dai media comuni verso i post\n// - Non sovrascrive error pre-esistenti con messaggi generici\n\nconst COMMON_LOCAL_DIR = '<PUT HERE YOUR LOCAL PATH>/';\nconst COMMON_REMOTE_DIR = '<PUT HERE YOUR REMOTE DIR>>';\n\n// Tutti i post (righe sheet) che devono usare i media comuni\nconst posts = $input.all();\n\n// Recupera la mappa mediaBySession dal nodo \"Aggregate Media URLs\"\n// Recupera la mappa mediaBySession dal nodo \"Aggregate Media URLs\"\nconst aggregateData = $('Aggregate Media URLs1').first().json;\nconst mediaBySession = aggregateData?.mediaBySession || {};\n\nconst results = [];\n\n// Helper per aggiungere un messaggio di errore senza perdere quello esistente\nfunction appendError(json, msg) {\n  if (!msg) return;\n  if (json.error_message && json.error_message !== msg) {\n    json.error_message = json.error_message + ' | ' + msg;\n  } else if (!json.error_message) {\n    json.error_message = msg;\n  }\n}\n\nfor (const post of posts) {\n  const json = { ...post.json };\n  const sid = json.session_id;\n  const sessionMedia = mediaBySession[sid] || {};\n\n  // ───────────────────────────────────────────────────────────\n  // Propaga SEMPRE info media comuni sulla riga (per email, ecc.)\n  // ───────────────────────────────────────────────────────────\n  if (sessionMedia.common_image_url) {\n    json.common_image_url = sessionMedia.common_image_url;\n    json.common_image_status = sessionMedia.common_image_status || 'GENERATED';\n  }\n  if (sessionMedia.common_video_url) {\n    json.common_video_url = sessionMedia.common_video_url;\n    json.common_video_status = sessionMedia.common_video_status || 'GENERATED';\n  }\n\n  // ───────────────────────────────────────────────────────────\n  // Helper: applica dettagli media comune a questo post\n  // kind: 'image' | 'video'\n  // ───────────────────────────────────────────────────────────\n  function applyCommonMedia(kind) {\n    const isImage = kind === 'image';\n\n    const urlKey       = isImage ? 'common_image_url'              : 'common_video_url';\n    const statusKey    = isImage ? 'common_image_status'           : 'common_video_status';\n    const filenameKey  = isImage ? 'common_image_filename'         : 'common_video_filename';\n    const localPathKey = isImage ? 'common_image_local_path'       : 'common_video_local_path';\n    const remotePathKey= isImage ? 'common_image_remote_path'      : 'common_video_remote_path';\n    const localFullKey = isImage ? 'common_image_local_full_path'  : 'common_video_local_full_path';\n    const remoteFullKey= isImage ? 'common_image_remote_full_path' : 'common_video_remote_full_path';\n\n    const url = sessionMedia[urlKey] || '';\n\n    // URL pubblico dell'asset comune\n    json.public_url = url;\n\n    // Filename (se disponibile da Aggregate)\n    const filename = sessionMedia[filenameKey] || '';\n    if (filename) {\n      json.final_filename = filename;\n      json.remote_filename = filename;\n    }\n\n    // Path locali/remoti: preferisci quelli salvati in Aggregate,\n    // altrimenti fallback sulle directory COMMON\n    const localDir  = sessionMedia[localPathKey]  || COMMON_LOCAL_DIR;\n    const remoteDir = sessionMedia[remotePathKey] || COMMON_REMOTE_DIR;\n\n    if (url) {\n      json.local_path  = localDir;\n      json.remotePath  = remoteDir;\n\n      const localFull  = sessionMedia[localFullKey]  || (filename ? localDir  + filename : '');\n      const remoteFull = sessionMedia[remoteFullKey] || (filename ? remoteDir + filename : '');\n\n      json.local_full_path  = localFull;\n      json.remote_full_path = remoteFull;\n    } else {\n      // Nessun media generato per questa sessione\n      if (json.status !== 'ERROR') {\n        json.status = 'ERROR';\n      }\n\n      const genericMsg = isImage\n        ? 'Generazione immagine comune fallita o non richiesta'\n        : 'Generazione video comune fallita o non richiesta';\n\n      appendError(json, genericMsg);\n\n      // Evita di lasciare path incoerenti in assenza di file\n      json.local_path = '';\n      json.remotePath = '';\n      json.local_full_path = '';\n      json.remote_full_path = '';\n    }\n\n    // Mantieni anche lo status del media comune (se serve a valle)\n    if (sessionMedia[statusKey]) {\n      const statusField = isImage ? 'common_image_status' : 'common_video_status';\n      json[statusField] = sessionMedia[statusKey];\n    }\n  }\n\n  // ───────────────────────────────────────────────────────────\n  // Applica i media comuni solo se il post li richiede\n  // ───────────────────────────────────────────────────────────\n  if (json.media_source === 'common_image') {\n    applyCommonMedia('image');\n  } else if (json.media_source === 'common_video') {\n    applyCommonMedia('video');\n  }\n\n  results.push({ json });\n}\n\nreturn results;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1584,
        -2960
      ],
      "id": "22b449ec-a678-4d7d-b872-bdb66603d8a9",
      "name": "Assign Media URLs to Posts1"
    },
    {
      "parameters": {
        "jsCode": "// Extract Media Tasks v2\n// Estrae i media UNICI da processare (sia Generati che Personali)\n// Output: una riga per ogni media con l'indicazione della sorgente (openai o drive)\n\nconst items = $input.all();\n\n// Raggruppa per session_id per evitare duplicati\nconst sessions = {};\n\nfor (const item of items) {\n  const json = item.json;\n  const sid = json.session_id;\n  \n  if (!sessions[sid]) {\n    sessions[sid] = {\n      session_id: sid,\n      user_email: json.user_email,\n      campaign_title: json.campaign_title,\n      // Dati per generazione OpenAI\n      generate_image: json.generate_common_image,\n      image_prompt: json.common_image_prompt,\n      generate_video: json.generate_common_video,\n      video_prompt: json.common_video_prompt,\n      // Dati per media personali (Drive)\n      personal_image_url: json.personal_image_url_drive,\n      personal_video_url: json.personal_video_url_drive\n    };\n  }\n}\n\n// Lista finale dei task (media da preparare)\nconst mediaTasks = [];\n\nfor (const sid in sessions) {\n  const s = sessions[sid];\n  \n  // 1. IMMAGINE COMUNE (OpenAI)\n  if (s.generate_image && s.image_prompt) {\n    mediaTasks.push({\n      json: {\n        _hasMediaTask: true,\n        session_id: sid,\n        user_email: s.user_email,\n        campaign_title: s.campaign_title,\n        media_type: 'image',\n        source_type: 'openai', // <-- Indica che va generata\n        prompt: s.image_prompt,\n        platform: 'common',\n      },\n    });\n  }\n  \n  // 2. VIDEO COMUNE (OpenAI)\n  if (s.generate_video && s.video_prompt) {\n    mediaTasks.push({\n      json: {\n        _hasMediaTask: true,\n        session_id: sid,\n        user_email: s.user_email,\n        campaign_title: s.campaign_title,\n        media_type: 'video',\n        source_type: 'openai', // <-- Indica che va generata\n        prompt: s.video_prompt,\n        platform: 'common',\n      },\n    });\n  }\n\n  // 3. IMMAGINE PERSONALE (Download da Drive)\n  if (s.personal_image_url && s.personal_image_url.trim() !== \"\") {\n    mediaTasks.push({\n      json: {\n        _hasMediaTask: true,\n        session_id: sid,\n        user_email: s.user_email,\n        campaign_title: s.campaign_title,\n        media_type: 'image',\n        source_type: 'drive',  // <-- Indica che va scaricata\n        drive_url: s.personal_image_url,\n        platform: 'personal',\n      },\n    });\n  }\n\n  // 4. VIDEO PERSONALE (Download da Drive)\n  if (s.personal_video_url && s.personal_video_url.trim() !== \"\") {\n    mediaTasks.push({\n      json: {\n        _hasMediaTask: true,\n        session_id: sid,\n        user_email: s.user_email,\n        campaign_title: s.campaign_title,\n        media_type: 'video',\n        source_type: 'drive',  // <-- Indica che va scaricata\n        drive_url: s.personal_video_url,\n        platform: 'personal',\n      },\n    });\n  }\n}\n\n// Se NON c'è nulla da processare (né AI né Personale)\nif (mediaTasks.length === 0) {\n  return [\n    {\n      json: {\n        _hasMediaTask: false,\n      },\n    },\n  ];\n}\n\nreturn mediaTasks;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        528,
        -3376
      ],
      "id": "ace0267d-5cc5-4234-aeb7-a57a267ad7a6",
      "name": "Extract Media Tasks1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "3157e232-ea3b-4033-8c70-963332a09e09",
              "leftValue": "={{ $json._hasMediaTask || false }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        768,
        -3376
      ],
      "id": "29457e8b-ed04-4fe8-86e7-a2f801863cb9",
      "name": "Has Media to Generate?1"
    },
    {
      "parameters": {
        "jsCode": "// Aggregate Media URLs v2\n// Raccoglie tutti i media generati con successo e costruisce\n// una mappa per session_id con URL + filename + path\n\nconst items = $input.all();\n\n// Mappa: session_id → dettagli media comuni\nconst mediaBySession = {};\n\nfor (const item of items) {\n  const json = item.json;\n\n  if (!json) continue;\n\n  // Salta errori espliciti\n  if (json.error || json.status === 'ERROR') continue;\n\n  const sid = json.session_id;\n  if (!sid) continue;\n\n  // Inizializza entry per la sessione se non esiste\n  if (!mediaBySession[sid]) {\n    mediaBySession[sid] = {\n      session_id: sid,\n\n      // 🔹 Immagine comune\n      common_image_url: '',\n      common_image_status: 'NOT_REQUESTED',\n      common_image_filename: '',\n      common_image_local_path: '',\n      common_image_remote_path: '',\n      common_image_local_full_path: '',\n      common_image_remote_full_path: '',\n\n      // 🔹 Video comune\n      common_video_url: '',\n      common_video_status: 'NOT_REQUESTED',\n      common_video_filename: '',\n      common_video_local_path: '',\n      common_video_remote_path: '',\n      common_video_local_full_path: '',\n      common_video_remote_full_path: '',\n    };\n  }\n\n  const entry = mediaBySession[sid];\n\n  // ---------------------------------------------------------------------------\n  // Immagine comune\n  // ---------------------------------------------------------------------------\n  if (json.media_type === 'image') {\n    if (json.public_url) {\n      entry.common_image_url = json.public_url;\n      entry.common_image_status = 'GENERATED';\n    }\n\n    if (json.final_filename) {\n      entry.common_image_filename = json.final_filename;\n    }\n\n    if (json.local_path) {\n      entry.common_image_local_path = json.local_path;\n    }\n\n    if (json.remotePath) {\n      entry.common_image_remote_path = json.remotePath;\n    }\n\n    if (json.local_full_path) {\n      entry.common_image_local_full_path = json.local_full_path;\n    } else if (entry.common_image_local_path && entry.common_image_filename) {\n      entry.common_image_local_full_path =\n        entry.common_image_local_path + entry.common_image_filename;\n    }\n\n    if (json.remote_full_path) {\n      entry.common_image_remote_full_path = json.remote_full_path;\n    } else if (entry.common_image_remote_path && entry.common_image_filename) {\n      entry.common_image_remote_full_path =\n        entry.common_image_remote_path + entry.common_image_filename;\n    }\n  }\n\n  // ---------------------------------------------------------------------------\n  // Video comune\n  // ---------------------------------------------------------------------------\n  if (json.media_type === 'video') {\n    if (json.public_url) {\n      entry.common_video_url = json.public_url;\n      entry.common_video_status = 'GENERATED';\n    }\n\n    if (json.final_filename) {\n      entry.common_video_filename = json.final_filename;\n    }\n\n    if (json.local_path) {\n      entry.common_video_local_path = json.local_path;\n    }\n\n    if (json.remotePath) {\n      entry.common_video_remote_path = json.remotePath;\n    }\n\n    if (json.local_full_path) {\n      entry.common_video_local_full_path = json.local_full_path;\n    } else if (entry.common_video_local_path && entry.common_video_filename) {\n      entry.common_video_local_full_path =\n        entry.common_video_local_path + entry.common_video_filename;\n    }\n\n    if (json.remote_full_path) {\n      entry.common_video_remote_full_path = json.remote_full_path;\n    } else if (entry.common_video_remote_path && entry.common_video_filename) {\n      entry.common_video_remote_full_path =\n        entry.common_video_remote_path + entry.common_video_filename;\n    }\n  }\n}\n\n// Output: un solo item con la mappa completa\nreturn [\n  {\n    json: {\n      mediaBySession,\n      sessionIds: Object.keys(mediaBySession),\n    },\n  },\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1216,
        -2960
      ],
      "id": "86d09be1-0dca-4fd2-8e7e-d0783c8db6fb",
      "name": "Aggregate Media URLs1"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "<PUT HERE YOUR GOOGLE SHEET ID>",
          "mode": "list",
          "cachedResultName": "Social_Media_Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Variabili_di_input-output",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit#gid=0"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "status",
              "lookupValue": "NEW"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1392,
        -2960
      ],
      "id": "4d7f71aa-bacb-4c7a-b9c6-c93a6a5180b6",
      "name": "Read Posts by Sessions1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "<PUT HERE YOUR_CREDENTIALS_ID>",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "<PUT HERE YOUR GOOGLE SHEET ID>",
          "mode": "list",
          "cachedResultName": "Social_Media_Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Variabili_di_input-output",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit#gid=0"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "status",
              "lookupValue": "NEW"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        976,
        -3136
      ],
      "id": "230be741-7177-44e4-9360-3238c3f86b65",
      "name": "Read Posts (no media branch)1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "<PUT HERE YOUR_CREDENTIALS_ID>",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Mark Ready (no media branch)\nconst items = $input.all();\n\nreturn items.map(item => {\n  const json = { ...item.json };\n  \n  if (json.status === 'NEW') {\n    json.status = 'READY_FOR_APPROVAL';\n  }\n  \n  return { json };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        976,
        -2912
      ],
      "id": "419bfb47-2449-4bda-8987-f1dbf4a4f9f5",
      "name": "Mark Ready (no media branch)1"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "<PUT HERE YOUR GOOGLE SHEET ID>",
          "mode": "list",
          "cachedResultName": "Social_Media_Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Variabili_di_input-output",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit#gid=0"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {},
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "import_source_row",
              "displayName": "import_source_row",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_email",
              "displayName": "user_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "campaign_title",
              "displayName": "campaign_title",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "platform",
              "displayName": "platform",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "post_text",
              "displayName": "post_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "hashtags",
              "displayName": "hashtags",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "media_source",
              "displayName": "media_source",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "media_type",
              "displayName": "media_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "media_variant",
              "displayName": "media_variant",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "scheduled_time",
              "displayName": "scheduled_time",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "publish_mode",
              "displayName": "publish_mode",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "target_phone_number",
              "displayName": "target_phone_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "approval_flag",
              "displayName": "approval_flag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "generate_common_image",
              "displayName": "generate_common_image",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_image_prompt",
              "displayName": "common_image_prompt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_image_status",
              "displayName": "common_image_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_image_url",
              "displayName": "common_image_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "generate_common_video",
              "displayName": "generate_common_video",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_video_prompt",
              "displayName": "common_video_prompt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_video_status",
              "displayName": "common_video_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "common_video_url",
              "displayName": "common_video_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "public_url",
              "displayName": "public_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "local_path",
              "displayName": "local_path",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "saved_locally",
              "displayName": "saved_locally",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "final_filename",
              "displayName": "final_filename",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "remote_filename",
              "displayName": "remote_filename",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "remotePath",
              "displayName": "remotePath",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "local_full_path",
              "displayName": "local_full_path",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "remote_full_path",
              "displayName": "remote_full_path",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "publish_attempts",
              "displayName": "publish_attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "error_message",
              "displayName": "error_message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "calendar_event_id",
              "displayName": "calendar_event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        976,
        -2752
      ],
      "id": "4a09c75a-de8c-4dc2-a5d6-ed1961dfda74",
      "name": "Update Sheet (no media branch)1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "<PUT HERE YOUR_CREDENTIALS_ID>",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "<PUT HERE YOUR GOOGLE SHEET ID>",
          "mode": "list",
          "cachedResultName": "Social_Media_Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 842035569,
          "mode": "list",
          "cachedResultName": "Risposte_del_modulo",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit#gid=842035569"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": "={{$json[\"import_source_row\"]}}",
            "import_status": "IMPORTED"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "Informazioni cronologiche",
              "displayName": "Informazioni cronologiche",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Indirizzo email",
              "displayName": "Indirizzo email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Titolo campagna",
              "displayName": "Titolo campagna",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Su quali piattaforme vuoi pubblicare?",
              "displayName": "Su quali piattaforme vuoi pubblicare?",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Vuoi pubblicare un'immagine?",
              "displayName": "Vuoi pubblicare un'immagine?",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Descrizione immagine:",
              "displayName": "Descrizione immagine:",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Vuoi pubblicare un video?",
              "displayName": "Vuoi pubblicare un video?",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Descrizione video",
              "displayName": "Descrizione video",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Testo del post Facebook",
              "displayName": "Testo del post Facebook",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Hashtag Facebook",
              "displayName": "Hashtag Facebook",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Media da utilizzare Facebook",
              "displayName": "Media da utilizzare Facebook",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Data e ora pubblicazione Facebook",
              "displayName": "Data e ora pubblicazione Facebook",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Testo del post Instagram",
              "displayName": "Testo del post Instagram",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Hashtag Instagram",
              "displayName": "Hashtag Instagram",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Media da utilizzare Instagram",
              "displayName": "Media da utilizzare Instagram",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Data e ora pubblicazione Instagram",
              "displayName": "Data e ora pubblicazione Instagram",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Testo del post TikTok",
              "displayName": "Testo del post TikTok",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Hashtag TikTok",
              "displayName": "Hashtag TikTok",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Media da utilizzare TikTok",
              "displayName": "Media da utilizzare TikTok",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Data e ora pubblicazione TikTok",
              "displayName": "Data e ora pubblicazione TikTok",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Testo del post YouTube",
              "displayName": "Testo del post YouTube",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Hashtag YouTube",
              "displayName": "Hashtag YouTube",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Media da utilizzare YouTube",
              "displayName": "Media da utilizzare YouTube",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Data e ora pubblicazione YouTube",
              "displayName": "Data e ora pubblicazione YouTube",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Destinatari WhatsApp (separati da una virgola)",
              "displayName": "Destinatari WhatsApp (separati da una virgola)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Testo del post WhatsApp",
              "displayName": "Testo del post WhatsApp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Hashtag WhatsApp",
              "displayName": "Hashtag WhatsApp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Media da utilizzare WhatsApp",
              "displayName": "Media da utilizzare WhatsApp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Data e ora pubblicazione WhatsApp",
              "displayName": "Data e ora pubblicazione WhatsApp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Testo del post X",
              "displayName": "Testo del post X",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Hashtag X/Twitter",
              "displayName": "Hashtag X/Twitter",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Media da utilizzare X",
              "displayName": "Media da utilizzare X",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Data e ora pubblicazione X",
              "displayName": "Data e ora pubblicazione X",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "import_status",
              "displayName": "import_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "source_row",
              "displayName": "source_row",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        352,
        -3200
      ],
      "id": "de83d6ef-7334-465b-9ce6-9e46f4c319ac",
      "name": "Mark as Imported1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "<PUT HERE YOUR_CREDENTIALS_ID>",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "name": "Process One Media at a Time1",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1008,
        -3392
      ],
      "id": "98c21bb1-2051-4e54-8535-7d53347f6bd9"
    },
    {
      "parameters": {
        "amount": 3
      },
      "name": "Wait Between Generations1",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        976,
        -3568
      ],
      "id": "b940f252-1b2a-4faf-b1b9-d65d0354c2bb",
      "webhookId": "media-wait-loop"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "filter-sheet-updates",
              "leftValue": "={{ $json._skipSheetUpdate }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1360,
        -2720
      ],
      "id": "2c08babe-c018-4a1c-b504-0ec13040e756",
      "name": "Filter Sheet Updates1"
    },
    {
      "parameters": {
        "jsCode": "// Log Media Errors - Scrive errori media su console/log\n// Questi errori non hanno id quindi non possono essere scritti sullo sheet principale\n\nconst items = $input.all();\n\nfor (const item of items) {\n  const json = item.json;\n  \n  console.error('=== MEDIA GENERATION ERROR ===');\n  console.error('Session ID:', json.session_id);\n  console.error('Media Type:', json.media_type);\n  console.error('Platform:', json.platform);\n  console.error('Error:', json.error_message);\n  console.error('Timestamp:', json.timestamp);\n  console.error('Prompt:', json.prompt);\n  console.error('==============================');\n}\n\n// Ritorna gli items per eventuale notifica email\nreturn items;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1616,
        -2656
      ],
      "id": "7f6027c8-a6d4-4fa4-a4b0-904c0f1a1635",
      "name": "Log Media Errors1"
    },
    {
      "parameters": {
        "jsCode": "// Set ERROR v2 - Con logging errori media\n// Gestisce sia errori su post (con id) che errori su media tasks (senza id)\n\nconst items = $input.all();\nconst out = [];\n\nfor (const item of items) {\n  const json = item.json;\n  const attempts = Number(json.publish_attempts || 0);\n\n  // ═══════════════════════════════════════════════════════════════════════════\n  // ERRORI SU MEDIA TASKS (senza id) - Log per diagnostica\n  // ═══════════════════════════════════════════════════════════════════════════\n  if (!json.id) {\n    if (json.error) {\n      // Crea un item di errore per notifica/logging\n      // Questo item NON verrà scritto sullo sheet principale\n      // ma può essere usato per alert o log separato\n      out.push({\n        json: {\n          _isMediaError: true,\n          _skipSheetUpdate: true,\n          session_id: json.session_id || 'unknown',\n          media_type: json.media_type || 'unknown',\n          platform: json.platform || 'common',\n          prompt: (json.prompt || '').substring(0, 200),\n          error_message: json.error.message || JSON.stringify(json.error),\n          error_code: json.error.code || '',\n          timestamp: new Date().toISOString()\n        }\n      });\n    }\n    // Non processare oltre - i media tasks non hanno riga sullo sheet\n    continue;\n  }\n\n  // ═══════════════════════════════════════════════════════════════════════════\n  // ERRORI SU POST (con id) - Aggiorna lo sheet\n  // ═══════════════════════════════════════════════════════════════════════════\n  if (json.error) {\n    json.status = 'ERROR';\n    json.approval_flag = 'REJECTED';\n    json.error_message = json.error.message || 'Media generation error';\n    json.publish_attempts = String(attempts + 1);\n  }\n\n  out.push({ json });\n}\n\nreturn out;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1200,
        -2720
      ],
      "id": "c299e54b-4c28-45cf-b6d0-6e1efbb0931c",
      "name": "Set ERROR2"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "<PUT HERE YOUR GOOGLE SHEET ID>",
          "mode": "list",
          "cachedResultName": "Social_Media_Automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Variabili_di_input-output",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/<PUT HERE YOUR GOOGLE SHEET ID>/edit#gid=0"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {},
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "error_message",
              "displayName": "error_message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "publish_attempts",
              "displayName": "publish_attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1632,
        -2800
      ],
      "id": "53e4718b-82e4-43b6-8107-04c3df6c86db",
      "name": "Update Sheet Error4",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "<PUT HERE YOUR_CREDENTIALS_ID>",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "dataType": "string",
        "value1": "={{ $json.media_type }}",
        "rules": {
          "rules": [
            {
              "value2": "image",
              "outputKey": "0"
            },
            {
              "value2": "video",
              "outputKey": "1"
            }
          ]
        }
      },
      "name": "Switch IG Media Type",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 2,
      "position": [
        1360,
        -912
      ],
      "id": "8c4aacc7-c34c-4c63-8989-f590510db48f"
    },
    {
      "parameters": {
        "httpRequestMethod": "POST",
        "graphApiVersion": "v23.0",
        "node": "<PUT HERE YOUR INSTAGRAM PAGE ID>",
        "edge": "media",
        "options": {
          "queryParameters": {
            "parameter": [
              {
                "name": "image_url",
                "value": "={{ $json.public_url }}"
              },
              {
                "name": "caption",
                "value": "={{ $json.post_text + '\\n\\n' + $json.hashtags }}"
              }
            ]
          }
        }
      },
      "name": "IG Create Image",
      "type": "n8n-nodes-base.facebookGraphApi",
      "typeVersion": 1,
      "position": [
        1552,
        -1072
      ],
      "id": "76a05d8e-3a2b-4e5f-ae4a-9923b9ecc4ca",
      "credentials": {
        "facebookGraphApi": {
          "id": "<<PUT HERE YOUR REDENTIAL_ID>",
          "name": "Facebook Graph account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "httpRequestMethod": "POST",
        "graphApiVersion": "v23.0",
        "node": "<PUT HERE YOUR INSTAGRAM PAGE ID>",
        "edge": "media",
        "options": {
          "queryParameters": {
            "parameter": [
              {
                "name": "video_url",
                "value": "={{ $json.public_url }}"
              },
              {
                "name": "caption",
                "value": "={{ $json.post_text + '\\n\\n' + $json.hashtags }}"
              },
              {
                "name": "media_type",
                "value": "REELS"
              }
            ]
          }
        }
      },
      "name": "IG Create Reels",
      "type": "n8n-nodes-base.facebookGraphApi",
      "typeVersion": 1,
      "position": [
        1552,
        -752
      ],
      "id": "11edc358-9017-4e4e-9af8-e23c983dfc4a",
      "credentials": {
        "facebookGraphApi": {
          "id": "<<PUT HERE YOUR REDENTIAL_ID>",
          "name": "Facebook Graph account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "jsCode": "// Salva i dati originali del post + l'ID del container video\nconst input = $input.first().json;\n\nreturn [{\n  json: {\n    ...input,\n    video_container_id: input.id,  // ID restituito da IG Create Reels\n    poll_count: 0\n  }\n}];"
      },
      "name": "Save Video Container ID",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1776,
        -768
      ],
      "id": "5c4af8e8-81a9-4c36-a7fd-c9623490d9af"
    },
    {
      "parameters": {
        "amount": 30,
        "unit": "seconds"
      },
      "name": "Wait Video Processing",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        1952,
        -768
      ],
      "id": "b275b926-4bc0-4cac-8b67-fd2994f2231c",
      "webhookId": "<PUT HERE YOUR WEBHOOK_ID>"
    },
    {
      "parameters": {
        "graphApiVersion": "v23.0",
        "node": "={{ $json.video_container_id }}",
        "options": {
          "queryParameters": {
            "parameter": [
              {
                "name": "fields",
                "value": "status_code,status"
              }
            ]
          }
        }
      },
      "name": "Check Video Status",
      "type": "n8n-nodes-base.facebookGraphApi",
      "typeVersion": 1,
      "position": [
        2144,
        -768
      ],
      "id": "8c1ca2e3-677a-45b8-adf1-3ee4cc0fab16",
      "credentials": {
        "facebookGraphApi": {
          "id": "<<PUT HERE YOUR REDENTIAL_ID>",
          "name": "Facebook Graph account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.status_code }}",
              "value2": "FINISHED"
            }
          ]
        }
      },
      "name": "Video Ready?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        2336,
        -784
      ],
      "id": "231e96df-3626-4adb-b11a-1886170886f1"
    },
    {
      "parameters": {
        "jsCode": "// Incrementa il contatore di polling e verifica se continuare\nconst input = $input.first().json;\nconst pollCount = (input.poll_count || 0) + 1;\n\n// Dopo 10 tentativi (5 minuti), considera fallito\nif (pollCount >= 10) {\n  throw new Error('Video processing timeout after 5 minutes');\n}\n\n// Recupera i dati originali dal nodo precedente\nconst savedData = $('Save Video Container ID').first().json;\n\nreturn [{\n  json: {\n    ...savedData,\n    poll_count: pollCount\n  }\n}];"
      },
      "name": "Increment Poll Count",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2544,
        -768
      ],
      "id": "cbcbf5b8-b25d-43b1-ac29-b3f6d75b141f"
    },
    {
      "parameters": {
        "jsCode": "// Prepara l'ID per la pubblicazione del video\nconst input = $input.first().json;\n\n// Recupera i dati originali\nconst savedData = $('Save Video Container ID').first().json;\n\nreturn [{\n  json: {\n    ...savedData,\n    id: savedData.video_container_id  // L'ID che serve per media_publish\n  }\n}];"
      },
      "name": "Prepare Video Publish",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1552,
        -928
      ],
      "id": "d61f421e-8238-44d0-b45b-656cb27c8a2b"
    },
    {
      "parameters": {
        "httpRequestMethod": "POST",
        "graphApiVersion": "v23.0",
        "node": "<PUT HERE YOUR INSTAGRAM PAGE ID>",
        "edge": "media_publish",
        "options": {
          "queryParameters": {
            "parameter": [
              {
                "name": "creation_id",
                "value": "={{ $json.id }}"
              }
            ]
          }
        }
      },
      "name": "IG Publish Media1",
      "type": "n8n-nodes-base.facebookGraphApi",
      "typeVersion": 1,
      "position": [
        1744,
        -1088
      ],
      "id": "84a04a63-e4b0-41e7-b869-521f2a83c3bf",
      "credentials": {
        "facebookGraphApi": {
          "id": "<<PUT HERE YOUR REDENTIAL_ID>",
          "name": "Facebook Graph account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "httpRequestMethod": "POST",
        "graphApiVersion": "v23.0",
        "node": "<PUT HERE YOUR INSTAGRAM PAGE ID>",
        "edge": "media_publish",
        "options": {
          "queryParameters": {
            "parameter": [
              {
                "name": "creation_id",
                "value": "={{ $json.id }}"
              }
            ]
          }
        }
      },
      "name": "IG Publish Media",
      "type": "n8n-nodes-base.facebookGraphApi",
      "typeVersion": 1,
      "position": [
        1744,
        -928
      ],
      "id": "0b2dcad7-2ab1-4a76-8375-f72f213dd145",
      "credentials": {
        "facebookGraphApi": {
          "id": "<<PUT HERE YOUR REDENTIAL_ID>",
          "name": "Facebook Graph account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition",
        "options": {}
      },
      "name": "Merge IG1",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [
        1984,
        -928
      ],
      "id": "db77d32c-98eb-4e9c-a0cb-1901c14131c3"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.source_type }}",
                    "rightValue": "openai",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "effece96-c89f-4eee-b8e8-c43b367e9e75"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "4ed01310-96be-48a2-9664-20145fa80234",
                    "leftValue": "={{ $json.source_type }}",
                    "rightValue": "drive",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        1248,
        -3376
      ],
      "id": "bed852cb-b213-4f7f-aa04-a5247c06632f",
      "name": "Switch"
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "={{ $json.drive_url.split('id=')[1] }}",
          "mode": "id"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        1808,
        -3360
      ],
      "id": "26005df3-93a4-411a-9295-632914eba66d",
      "name": "Google Drive (Download file)",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "<<PUT HERE YOUR REDENTIAL_ID>",
          "name": "Google Drive account"
        }
      }
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Read Session Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Apply Approval Logic": {
      "main": [
        [
          {
            "node": "Needs Calendar?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Needs Calendar?": {
      "main": [
        [
          {
            "node": "Create Calendar Event",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge Calendar Data",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "Update Sheet (No Calendar)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Calendar Event": {
      "main": [
        [
          {
            "node": "Merge Calendar Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Calendar Data": {
      "main": [
        [
          {
            "node": "Prepare Calendar Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter with Event ID": {
      "main": [
        [
          {
            "node": "Get Calendar Event",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge Event Data",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Get Calendar Event": {
      "main": [
        [
          {
            "node": "Merge Event Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set PUBLISHING ERRORS1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Event Data": {
      "main": [
        [
          {
            "node": "Check Changes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Changes": {
      "main": [
        [
          {
            "node": "Update Sheet1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cron2": {
      "main": [
        [
          {
            "node": "Read Scheduled Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Errors": {
      "main": [
        [
          {
            "node": "Send Alert Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cron4": {
      "main": [
        [
          {
            "node": "Read All Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter by Time": {
      "main": [
        [
          {
            "node": "Switch Platform 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch Platform 1": {
      "main": [
        [
          {
            "node": "Merge FB Image",
            "type": "main",
            "index": 1
          },
          {
            "node": "Switch Platform ",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge FB Video",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "Merge IG",
            "type": "main",
            "index": 1
          },
          {
            "node": "Switch IG Media Type",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge IG1",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "Merge TikTok",
            "type": "main",
            "index": 1
          },
          {
            "node": "TikTok Publish",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch Platform 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch Platform 2": {
      "main": [
        [
          {
            "node": "YouTube Publish",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge YT",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "WhatsApp Publish",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge WA",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "X Publish",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge X",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "YouTube Publish": {
      "main": [
        [
          {
            "node": "Merge YT",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set PUBLISHING ERRORS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WhatsApp Publish": {
      "main": [
        [
          {
            "node": "Merge WA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set PUBLISHING ERRORS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "X Publish": {
      "main": [
        [
          {
            "node": "Merge X",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set PUBLISHING ERRORS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge IG": {
      "main": [
        [
          {
            "node": "Set Publish Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge TikTok": {
      "main": [
        [
          {
            "node": "Set Publish Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge YT": {
      "main": [
        [
          {
            "node": "Set Publish Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge WA": {
      "main": [
        [
          {
            "node": "Set Publish Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge X": {
      "main": [
        [
          {
            "node": "Set Publish Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cron3": {
      "main": [
        [
          {
            "node": "Read Scheduled",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "TikTok Publish": {
      "main": [
        [
          {
            "node": "Merge TikTok",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set PUBLISHING ERRORS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Scheduled Items": {
      "main": [
        [
          {
            "node": "Filter with Event ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Sheet (No Calendar)1": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Sheet (Calendar)1": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Session Items": {
      "main": [
        [
          {
            "node": "Apply Approval Logic",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Scheduled": {
      "main": [
        [
          {
            "node": "Tag Sheet ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read All Items": {
      "main": [
        [
          {
            "node": "Filter Errors",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Publish Status": {
      "main": [
        [
          {
            "node": "Update Status",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set PUBLISHING ERRORS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Calendar Update": {
      "main": [
        [
          {
            "node": "Update Sheet (Calendar)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set PUBLISHING ERRORS": {
      "main": [
        [
          {
            "node": "Update Sheet Error1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Facebook Publish Image": {
      "main": [
        [
          {
            "node": "Merge FB Image",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set PUBLISHING ERRORS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Facebook Publish VIdeo": {
      "main": [
        [
          {
            "node": "Merge FB Video",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set PUBLISHING ERRORS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch Platform ": {
      "main": [
        [
          {
            "node": "Facebook Publish Image",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Facebook Publish VIdeo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Facebook Publish Text",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge FB text",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge FB Image": {
      "main": [
        [
          {
            "node": "Set Publish Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge FB Video": {
      "main": [
        [
          {
            "node": "Set Publish Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set PUBLISHING ERRORS1": {
      "main": [
        [
          {
            "node": "Update Sheet Error2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tag Sheet ID": {
      "main": [
        [
          {
            "node": "Filter by Time",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge FB text": {
      "main": [
        [
          {
            "node": "Set Publish Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Facebook Publish Text": {
      "main": [
        [
          {
            "node": "Merge FB text",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set PUBLISHING ERRORS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize Data1": {
      "main": [
        [
          {
            "node": "Write to Output Sheet",
            "type": "main",
            "index": 0
          },
          {
            "node": "Mark as Imported1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch Media Type1": {
      "main": [
        [
          {
            "node": "OpenAI Video Gen1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge Video Data1",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "OpenAI Image Gen1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge Image Data1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "OpenAI Video Gen1": {
      "main": [
        [
          {
            "node": "Merge Video Data1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set ERROR2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Image Gen1": {
      "main": [
        [
          {
            "node": "Merge Image Data1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set ERROR2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Video Data1": {
      "main": [
        [
          {
            "node": "Calculate Paths1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Image Data1": {
      "main": [
        [
          {
            "node": "Calculate Paths1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculate Paths1": {
      "main": [
        [
          {
            "node": "Check Gen Error1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Gen Error1": {
      "main": [
        [
          {
            "node": "Set ERROR2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Save to Local Disk1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save to Local Disk1": {
      "main": [
        [
          {
            "node": "SSH Host Sync1",
            "type": "main",
            "index": 0
          },
          {
            "node": "FTP Upload1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FTP Upload1": {
      "main": [
        [
          {
            "node": "Wait Between Generations1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set ERROR2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Group by Session1": {
      "main": [
        [
          {
            "node": "Build Approval Email1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Form Responses1": {
      "main": [
        [
          {
            "node": "Normalize Data1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Write to Output Sheet": {
      "main": [
        [
          {
            "node": "Extract Media Tasks1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Approval Email1": {
      "main": [
        [
          {
            "node": "Send a message1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "Group by Session1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Sheet (Media – Ready for Approval)1": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Mark Media Ready For Approval1": {
      "main": [
        [
          {
            "node": "Update Sheet (Media – Ready for Approval)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Sheets Trigger1": {
      "main": [
        [
          {
            "node": "Read Form Responses1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SSH Host Sync1": {
      "main": [
        [],
        [
          {
            "node": "Set ERROR2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Assign Media URLs to Posts1": {
      "main": [
        [
          {
            "node": "Mark Media Ready For Approval1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Media Tasks1": {
      "main": [
        [
          {
            "node": "Has Media to Generate?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Media to Generate?1": {
      "main": [
        [
          {
            "node": "Process One Media at a Time1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Read Posts (no media branch)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate Media URLs1": {
      "main": [
        [
          {
            "node": "Read Posts by Sessions1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Posts by Sessions1": {
      "main": [
        [
          {
            "node": "Assign Media URLs to Posts1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Posts (no media branch)1": {
      "main": [
        [
          {
            "node": "Mark Ready (no media branch)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mark Ready (no media branch)1": {
      "main": [
        [
          {
            "node": "Update Sheet (no media branch)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Sheet (no media branch)1": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process One Media at a Time1": {
      "main": [
        [
          {
            "node": "Aggregate Media URLs1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait Between Generations1": {
      "main": [
        [
          {
            "node": "Process One Media at a Time1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Sheet Updates1": {
      "main": [
        [
          {
            "node": "Update Sheet Error4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Media Errors1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set ERROR2": {
      "main": [
        [
          {
            "node": "Filter Sheet Updates1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch IG Media Type": {
      "main": [
        [
          {
            "node": "IG Create Image",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "IG Create Reels",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IG Create Image": {
      "main": [
        [
          {
            "node": "IG Publish Media1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set PUBLISHING ERRORS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IG Create Reels": {
      "main": [
        [
          {
            "node": "Save Video Container ID",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set PUBLISHING ERRORS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Video Container ID": {
      "main": [
        [
          {
            "node": "Wait Video Processing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait Video Processing": {
      "main": [
        [
          {
            "node": "Check Video Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Video Status": {
      "main": [
        [
          {
            "node": "Video Ready?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set PUBLISHING ERRORS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Video Ready?": {
      "main": [
        [
          {
            "node": "Prepare Video Publish",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Increment Poll Count",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Increment Poll Count": {
      "main": [
        [
          {
            "node": "Wait Video Processing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Video Publish": {
      "main": [
        [
          {
            "node": "IG Publish Media",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IG Publish Media1": {
      "main": [
        [
          {
            "node": "Merge IG",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set PUBLISHING ERRORS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IG Publish Media": {
      "main": [
        [
          {
            "node": "Merge IG1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set PUBLISHING ERRORS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge IG1": {
      "main": [
        [
          {
            "node": "Set Publish Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Switch Media Type1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Google Drive (Download file)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Drive (Download file)": {
      "main": [
        [
          {
            "node": "Calculate Paths1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "instanceId": "<PUT HERE YOUR INSTANCE_ID>"
  }
}
